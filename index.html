<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>InfoCana ‚Ä¢ USCO </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb"/>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"> </script>
  <style>.tab-btn.active {border-color: #2563eb; /* Azul principal */color: #2563eb;font-weight: 600;}.tab-btn {
   transition: all 0.2s ease-in-out;}.aba-bloqueada {opacity: 0.5;pointer-events: none;cursor: not-allowed;}#menuAbas {opacity: 0;transform: scaleY(0.95);transform-origin: top right;}#menuAbas.show {opacity: 1;transform: scaleY(1);}.menu-icon .bar {
  left: 0;
}

.menu-icon.open .bar:nth-child(1) {
  transform: rotate(45deg);
  top: 12px;
}

.menu-icon.open .bar:nth-child(2) {
  opacity: 0;
}

.menu-icon.open .bar:nth-child(3) {
  transform: rotate(-45deg);
  top: 12px;
}

</style>

</head>


<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8 px-4 font-sans text-gray-800">

    <div id="loginScreen" class="w-full max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold text-center text-orange-600 mb-6">InfoCana ‚Ä¢ Acesso</h2>
    <form id="formLoginOperador" class="space-y-4">
      <div>
        <label for="loginMatricula" class="block text-sm font-semibold mb-1">Matr√≠cula</label>
        <input id="loginMatricula" type="text" required class="w-full border rounded px-3 py-2" placeholder="Digite sua matr√≠cula" />
      </div>
      <div>
        <label for="loginNome" class="block text-sm font-semibold mb-1">Usu√°rio</label>
        <input id="loginNome" type="text" required class="w-full border rounded px-3 py-2" placeholder="Digite seu nome, ex: joao jose" />
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Entrar</button>
    </form>
    <div id="loginError" class="hidden mt-4 text-center text-red-600 text-sm"></div>
    <div class="mt-4 text-center text-sm">
      <button id="btnAdminLogin" class="text-blue-600 hover:underline">Acesso Administrador</button>
    </div>
  </div>




  <main class="w-full max-w-6xl hidden">
    <header class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
      <h1 class="text-2xl font-bold text-orange-600">InfoCana ‚Ä¢ USCO</h1>
      <button id="btnSessao" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Sair</button>
    </header>

    <div id="mensagem" class="hidden p-3 rounded mb-4"></div>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <span id="dotConexao" class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
        <span id="txtConexao" class="text-sm text-gray-700">Conectado</span>
      </div>
      <div class="text-xs text-gray-500">
        As altera√ß√µes feitas <strong>offline</strong> ser√£o sincronizadas automaticamente ao restabelecer a conex√£o.
      </div>
    </div>
    

<div id="navContainer" class="border-b border-gray-200 mb-6 flex items-center justify-between">
  <nav class="-mb-px hidden md:flex space-x-6" aria-label="Tabs">
    <button data-tab="projetos"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìÇ Projetos
    </button>

    <button data-tab="cadastro"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìù Cadastro de √Åreas
    </button>

    <button data-tab="operador"
      class="tab-btn flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-blue-600 border-blue-600 active">
      ‚úÖ √Åreas Cadastradas
    </button>

    <button data-tab="relatorios"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìä Relat√≥rios
    </button>
  </nav>

  <div class="relative md:hidden ml-auto">
    <button id="menuAbasBtn" class="flex items-center gap-2 py-3 px-4 text-gray-700 hover:text-blue-600 font-medium">
      <span id="menuAbasLabel"></span> <div class="menu-icon w-6 h-6 relative">
        <span class="bar absolute top-1 w-6 h-0.5 bg-current transition-all duration-300"></span>
        <span class="bar absolute top-3 w-6 h-0.5 bg-current transition-all duration-300"></span>
        <span class="bar absolute top-5 w-6 h-0.5 bg-current transition-all duration-300"></span>
      </div>
    </button>

    <div id="menuAbas" class="hidden absolute right-0 mt-2 w-56 bg-white border rounded shadow-lg z-20">
      </div>
  </div>
</div>

      <section id="content-projetos" class="p-6 hidden space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-orange-600">Projetos</h1>
        <p class="text-sm text-gray-600">Gerencie os projetos, insira ou remova.</p>

        <form id="formProjeto" class="flex gap-2 items-end">
          <div class="flex-1">
            <label for="novoProjeto" class="block text-sm font-semibold mb-1">Novo Projeto</label>
            <input id="novoProjeto" class="w-full border rounded px-3 py-2" placeholder="Ex: Projeto A" />
          </div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Adicionar</button>
        </form>

        <div>
          <h3 class="font-semibold mb-2">Lista de Projetos</h3>
          <ul id="listaProjetos" class="space-y-2"></ul>
        </div>
      </section>

      <section id="content-cadastro" class="p-6 hidden space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-orange-600">Cadastro de √Åreas</h1>

        <form id="formArea" class="space-y-6" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label for="projeto" class="block text-sm font-semibold mb-1">Projeto</label>
              <select id="projeto" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div>
              <label for="bombeamento" class="block text-sm font-semibold mb-1">Bombeamento</label>
              <input id="bombeamento" required class="w-full border rounded px-3 py-2" placeholder="Ex: B01" />
            </div>
            <div>
              <label for="bloco" class="block text-sm font-semibold mb-1">Nome do Bloco</label>
              <input id="bloco" required class="w-full border rounded px-3 py-2" placeholder="Ex: 21 - Vila EB1" />
            </div>
            
            <div>
              <label for="numeroEletrobomba" class="block text-sm font-semibold mb-1">N¬∞ Eletrobomba</label>
              <input id="numeroEletrobomba" required class="w-full border rounded px-3 py-2" placeholder="Ex: 130001" />
            </div>
            <div>
                <label for="quantidadeCarreteis" class="block text-sm font-semibold mb-1">Quantidade de Carret√©is</label>
                <input id="quantidadeCarreteis" type="number" min="1" required class="w-full border rounded px-3 py-2" placeholder="Ex: 2" />
            </div>
            <div>
              <label for="tipoArea" class="block text-sm font-semibold mb-1">Tipo de √Årea</label>
              <select id="tipoArea" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
              <option value="">-- Selecione --</option>
              <option value="Moagem">Moagem</option>
              <option value="Pr√©-plantio">Pr√©-plantio</option>
              <option value="Plantio">Plantio</option>
              <option value="Socaria">Socaria</option>
              </select>
            </div>
             <div>
              <label for="redeEletrica" class="block text-sm font-semibold mb-1">Rede El√©trica</label>
              <select id="redeEletrica" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
                <option value="">-- Selecione --</option>
                <option value="RD ELET. ST¬∞ ANTONIO">RD ELET. ST¬∞ ANTONIO</option>
                <option value="RD ELET. MATO GROSSO">RD ELET. MATO GROSSO</option>
                <option value="RD ELET. RIACH√ÉO">RD ELET. RIACH√ÉO</option>
                <option value="RD ELET. PROGRESSO">RD ELET. PROGRESSO</option>
                <option value="RD ELET. VILA">RD ELET. VILA</option>
                <option value="RD SUBEST. 69">RD SUBEST. 69</option>
                <option value="REDE CASA DE FOR√áA">REDE CASA DE FOR√áA</option>
                <option value="REDE EQUATORIAL">REDE EQUATORIAL</option>
              </select>
            </div>
            <div id="carreteisContainer" class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
             <div>
              <label for="tipoIrrigacao" class="block text-sm font-semibold mb-1">Tipo de Irriga√ß√£o</label>
               <select id="tipoIrrigacao" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
              <option value="">-- Selecione --</option>
              <option value="Carretel">Carretel</option>
              <option value="Pivo">Pivo</option>
              <option value="Convencional">Convencional</option>
              <option value="Pressurizada">Pressurizada</option>
              </select>
             </div>
             <div>
               <label for="tipoProduto" class="block text-sm font-semibold mb-1">Produto</label>
               <select id="tipoProduto" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
               <option value="">-- Selecione --</option>
               <option value="√Ågua Limpa">√Ågua Limpa</option>
               <option value="√Ågua Reuso">√Ågua Reuso</option>
               <option value="Vinha√ßa">Vinha√ßa</option>
               </select>
            </div>
            <div>
              <label for="horasPlanejadas" class="block text-sm font-semibold mb-1">Horas Planejadas (dia)</label>
              <input id="horasPlanejadas" type="number" min="0" max="24" step="0.25" required class="w-full border rounded px-3 py-2" placeholder="Ex: 24" />
            </div>
            <div>
              <label for="velocidadeCarretel" class="block text-sm font-semibold mb-1">Velocidade do Carretel (m/h)</label>
              <input id="velocidadeCarretel" type="number" min="0" step="0.1" required class="w-full border rounded px-3 py-2" placeholder="Ex: 15.5" />
            </div>
            <div>
              <label for="metrosLineares" class="block text-sm font-semibold mb-1">Metros Lineares (m)</label>
              <input id="metrosLineares" readonly class="w-full border rounded px-3 py-2 bg-gray-200" placeholder="Calculado" />
            </div>
            <div>
              <label for="numeroCroqui" class="block text-sm font-semibold mb-1">N¬∞ Croqui</label>
              <input id="numeroCroqui" required class="w-full border rounded px-3 py-2" placeholder="Ex: 0001" />
            </div>
            <div>
              <label for="proxBloco" class="block text-sm font-semibold mb-1">Pr√≥x. Bloco a Irrigar</label>
              <input id="proxBloco" class="w-full border rounded px-3 py-2" placeholder="Ex: 22 - Vila EB2" />
            </div>
            <div>
              <label for="vazao" class="block text-sm font-semibold mb-1">Vaz√£o m¬≥/h</label>
              <input id="vazao" required class="w-full border rounded px-3 py-2" placeholder="Ex: 120 m¬≥/h" />
            </div>

          </div>

          <div class="flex justify-end gap-3">
            <button type="submit" id="salvarArea" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar √Årea</button>
            <button type="button" id="cancelarEdicao" class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
          </div>
        </form>

        <hr class="border-gray-200" />

        <div>
          <label for="filtroProjetoCadastro" class="block mb-2 font-semibold text-gray-700">Filtrar √Åreas por Projeto</label>
          <select id="filtroProjetoCadastro" class="w-full max-w-sm border rounded px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
            <option value="">-- Todos os Projetos --</option>
          </select>
        </div>

        <div id="listaAreasCadastro" class="space-y-3"></div>
      </section>

      <section id="content-operador" class="p-6 hidden space-y-6">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <h2 class="text-2xl md:text-3xl font-semibold text-orange-600">Operador</h2>
          </div>
          <div class="flex gap-2">

            <button id="btnExportCSV" class="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 text-sm">Exportar CSV (dia)</button>
            <button id="btnExportPDF" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm">Exportar PDF (dia)</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroProjetoOperador">Projeto</label>
            <select id="filtroProjetoOperador" class="w-full border rounded px-3 py-2">
              <option value="">-- Todos os Projetos --</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="filtroDataOperador">Data</label>
            <input type="date" id="filtroDataOperador" class="w-full border rounded px-3 py-2" />
          </div>
          <div class="flex items-end">
            <button id="btnFiltrarOperador" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Aplicar Filtros</button>
          </div>
        </div>

        <div id="listaAreasOperador" class="space-y-3"></div>
      </section>

      <section id="content-relatorios" class="p-6 hidden space-y-6">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <h2 class="text-2xl md:text-3xl font-semibold text-orange-600">Relat√≥rios</h2>
            <p class="text-sm text-gray-600">Consolida√ß√£o di√°ria por projeto e por √°rea.</p>
          </div>
          <div class="flex gap-2">
            <button id="btnExportCSVRel" class="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 text-sm">Exportar CSV (Relat√≥rio)</button>
            <button id="btnExportPDFRel" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm">Exportar PDF (Relat√≥rio)</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroProjetoRel">Projeto</label>
            <select id="filtroProjetoRel" class="w-full border rounded px-3 py-2">
              <option value="">-- Todos os Projetos --</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="filtroDataRel">Data</label>
            <input type="date" id="filtroDataRel" class="w-full border rounded px-3 py-2" />
          </div>
          <div class="flex items-end">
            <button id="btnGerarRelatorio" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gerar</button>
          </div>
        </div>

        <div id="sumarioRel" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-2">
          <div class="flex items-center space-x-3 bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <div class="text-xs font-semibold text-blue-700 uppercase">Horas Planejadas</div>
              <div id="sumPlanejadas" class="text-2xl font-bold text-blue-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-amber-50 border border-amber-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
            <div>
              <div class="text-xs font-semibold text-amber-700 uppercase">Horas Paradas</div>
              <div id="sumParadas" class="text-2xl font-bold text-amber-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-emerald-50 border border-emerald-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.944 12c.032 4.418 2.378 8.42 6.114 10.153a1 1 0 001.077-.042A12.01 12.01 0 0012 21.056c4.418-.032 8.42-2.378 10.153-6.114a1 1 0 00-.042-1.077c-1.734-2.221-4.075-3.951-6.114-5.642z" /></svg>
            <div>
              <div class="text-xs font-semibold text-emerald-700 uppercase">Horas Rodadas</div>
              <div id="sumRodadas" class="text-2xl font-bold text-emerald-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-purple-50 border border-purple-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M4 8h16M4 16h16" /></svg>
            <div>
              <div class="text-xs font-semibold text-purple-700 uppercase">Efici√™ncia</div>
              <div id="sumEficiencia" class="text-2xl font-bold text-purple-900">0%</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-teal-50 border border-teal-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7.5l-2.165 2.165a1.583 1.583 0 00-2.243 0L10 17.25m6-4.5L10 17.25M7.5 4.5l-3 3m10.5 6L8.25 10.5M5.25 15.75l-1.5 1.5M10.5 4.5l-3 3" /></svg>
            <div>
              <div class="text-xs font-semibold text-teal-700 uppercase">Metros Lineares (m)</div>
              <div class="text-xl font-bold text-teal-900">
                  Plano: <span id="sumMetrosPlano">0</span>
              </div>
              <div class="text-xl font-bold text-teal-900">
                  Real: <span id="sumMetrosReal">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-green-700 uppercase">Hectares Irrigados (ha)</div>
              <div class="text-xl font-bold text-green-900">
                  Plano: <span id="sumHectaresPlano">0</span>
              </div>
              <div class="text-xl font-bold text-green-900">
                  Real: <span id="sumHectaresReal">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-cyan-50 border border-cyan-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-cyan-700 uppercase">Metros Lineares (Hor√≠metro)</div>
              <div id="sumMetrosHorimetro" class="text-2xl font-bold text-cyan-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-sky-50 border border-sky-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m8-8h2M4 12H2m15.364 6.364l1.414 1.414M4.222 4.222l1.414 1.414m12.728 0l-1.414 1.414M5.636 18.364l-1.414 1.414" /></svg>
            <div>
              <div class="text-xs font-semibold text-sky-700 uppercase">Irrig. Complementar (h)</div>
              <div id="sumComplementar" class="text-2xl font-bold text-sky-900">0</div>
            </div>
          </div>
        </div>

        <div id="tabelaRel" class="space-y-3 mt-4"></div>

        <hr class="border-gray-200 my-8" />

        <h3 class="text-xl md:text-2xl font-semibold text-blue-900">Relat√≥rio por √Årea</h3>
        <p class="text-sm text-gray-600">Gere um relat√≥rio detalhado para uma √°rea espec√≠fica.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroAreaIndividual">Selecionar √Årea</label>
            <select id="filtroAreaIndividual" class="w-full border rounded px-3 py-2">
              <option value="">-- Selecione uma √Årea --</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnGerarRelatorioIndividual" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gerar Relat√≥rio Individual</button>
          </div>
        </div>

        <div id="sumarioRelIndividual" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-2">
          <div class="flex items-center space-x-3 bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <div class="text-xs font-semibold text-blue-700 uppercase">Horas Planejadas</div>
              <div id="sumPlanejadasInd" class="text-2xl font-bold text-blue-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-amber-50 border border-amber-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
            <div>
              <div class="text-xs font-semibold text-amber-700 uppercase">Horas Paradas</div>
              <div id="sumParadasInd" class="text-2xl font-bold text-amber-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-emerald-50 border border-emerald-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.944 12c.032 4.418 2.378 8.42 6.114 10.153a1 1 0 001.077-.042A12.01 12.01 0 0012 21.056c4.418-.032 8.42-2.378 10.153-6.114a1 1 0 00-.042-1.077c-1.734-2.221-4.075-3.951-6.114-5.642z" /></svg>
            <div>
              <div class="text-xs font-semibold text-emerald-700 uppercase">Horas Rodadas</div>
              <div id="sumRodadasInd" class="text-2xl font-bold text-emerald-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-purple-50 border border-purple-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M4 8h16M4 16h16" /></svg>
            <div>
              <div class="text-xs font-semibold text-purple-700 uppercase">Efici√™ncia</div>
              <div id="sumEficienciaInd" class="text-2xl font-bold text-purple-900">0%</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-teal-50 border border-teal-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7.5l-2.165 2.165a1.583 1.583 0 00-2.243 0L10 17.25m6-4.5L10 17.25M7.5 4.5l-3 3m10.5 6L8.25 10.5M5.25 15.75l-1.5 1.5M10.5 4.5l-3 3" /></svg>
            <div>
              <div class="text-xs font-semibold text-teal-700 uppercase">Metros Lineares (m)</div>
              <div class="text-xl font-bold text-teal-900">
                  Plano: <span id="sumMetrosPlanoInd">0</span>
              </div>
              <div class="text-xl font-bold text-teal-900">
                  Real: <span id="sumMetrosRealInd">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-green-700 uppercase">Hectares Irrigados (ha)</div>
              <div class="text-xl font-bold text-green-900">
                  Plano: <span id="sumHectaresPlanoInd">0</span>
              </div>
              <div class="text-xl font-bold text-green-900">
                  Real: <span id="sumHectaresRealInd">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-cyan-50 border border-cyan-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-cyan-700 uppercase">Metros Lineares (Hor√≠metro)</div>
              <div id="sumMetrosHorimetroInd" class="text-2xl font-bold text-cyan-900">0</div>
            </div>
          </div>
           <div class="flex items-center space-x-3 bg-sky-50 border border-sky-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m8-8h2M4 12H2m15.364 6.364l1.414 1.414M4.222 4.222l1.414 1.414m12.728 0l-1.414 1.414M5.636 18.364l-1.414 1.414" /></svg>
            <div>
              <div class="text-xs font-semibold text-sky-700 uppercase">Irrig. Complementar (h)</div>
              <div id="sumComplementarInd" class="text-2xl font-bold text-sky-900">0</div>
            </div>
          </div>
        </div>
        <div id="tabelaRelIndividual" class="space-y-3 mt-4"></div>
      </section>
    </div>
  </main>



  <div id="modalParada" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white w-full max-w-xl rounded-lg shadow-lg p-6 relative max-h-[90vh] overflow-y-auto">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      <h3 id="modalTitle" class="text-xl font-semibold mb-4">Registrar Atividade Di√°ria</h3>

      <div id="modalInfoArea" class="text-sm text-gray-700 mb-4"></div>

      <form id="formParada" class="space-y-4" novalidate>
        <fieldset class="border rounded p-3">
          <legend class="font-semibold text-gray-800">Tipo de Registro</legend>
          <div class="flex flex-wrap gap-4 pt-1">
              <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="tipoRegistro" value="sem_parada" class="form-radio text-blue-600" required checked />
                  <span class="ml-2">Opera√ß√£o Normal (sem parada)</span>
              </label>
              <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="tipoRegistro" value="parada" class="form-radio text-blue-600" />
                  <span class="ml-2 text-red-700 font-medium">Registrar Parada</span>
              </label>
              <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="tipoRegistro" value="complementar" class="form-radio text-blue-600" />
                  <span class="ml-2 text-cyan-700 font-medium">Irriga√ß√£o Complementar</span>
              </label>
          </div>
        </fieldset>

        <div id="camposRegistro" class="hidden space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-semibold">In√≠cio</label>
                <input id="inicioParada" type="datetime-local" class="w-full border rounded px-3 py-2" required />
              </div>
              <div>
                <label class="block text-sm font-semibold">T√©rmino</label>
                <input id="fimParada" type="datetime-local" class="w-full border rounded px-3 py-2" required />
              </div>
            </div>
            <div class="text-sm text-gray-700">Dura√ß√£o: <span id="duracaoParada">-</span></div>
            <div id="alertOverlap" class="hidden text-sm text-red-600">‚ö†Ô∏è O intervalo informado se sobrep√µe a um registro existente.</div>

            <div id="detalhesParada" class="hidden space-y-3 border-t pt-3 mt-3">
              <div>
                <label class="block text-sm font-semibold">Tipo de equipamento</label>
                <select id="codParada" class="w-full border rounded px-3 py-2" required>
                  <option value="">Selecione</option>
                  <option value="E">Eletrobomba (E)</option>
                  <option value="C">Carretel (C)</option>
                  <option value="R">Rede (R)</option>
                </select>
              </div>
              
               <div id="infoRedeEletrica" class="hidden text-sm p-2 bg-blue-50 border border-blue-200 rounded"></div>

              <div id="selecaoCarretelParada" class="hidden">
                  <label class="block text-sm font-semibold">Selecione o Carretel</label>
                  <select id="numeroCarretelParada" class="w-full border rounded px-3 py-2" required></select>
              </div>

              <div>
                <label for="horimetroInicial" class="block text-sm font-medium text-gray-700">Hor√≠metro Inicial</label>
                <input type="text" id="horimetroInicial" name="horimetroInicial" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ex: 1234.5">
              </div>
              <div>
                <label for="horimetroFinal" class="block text-sm font-medium text-gray-700">Hor√≠metro Final</label>
                <input type="text" id="horimetroFinal" name="horimetroFinal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ex: 1235.0">
              </div>

              <div>
                <label class="block text-sm font-semibold">Equipamento/Rede com problema</label>
                <input id="equipamentoProblemaModal" type="text" class="w-full border rounded px-3 py-2" placeholder="Ex: 130001 ou Rede St.Antonio" />
              </div>

              <div>
                <label class="block text-sm font-semibold">Descri√ß√£o da Parada (c√≥digo)</label>
                <select id="descricaoParadaCodigoSelect" class="w-full border rounded px-3 py-2" required></select>
              </div>

              <div>
                <label class="block text-sm font-semibold">Descri√ß√£o do Problema (selecione um ou mais)</label>
                <div id="listaProblemas" class="max-h-48 overflow-y-auto border rounded p-2 space-y-1 mt-1">
                </div>
                <div class="mt-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="problemaOutro" class="form-checkbox">
                        <span class="ml-2">Outro</span>
                    </label>
                    <textarea id="descricaoProblemaOutro" class="hidden w-full border rounded px-3 py-2 mt-1" rows="2" placeholder="Descreva o outro problema"></textarea>
                </div>
              </div>
            </div>
            
            <div id="detalhesComplementar" class="hidden space-y-3 border-t pt-3 mt-3">
                <p class="text-sm font-medium text-gray-800">Detalhes da Irriga√ß√£o Complementar</p>
                <p class="text-xs text-gray-600">Selecione o carretel que foi substitu√≠do pelo canh√£o de espera.</p>
                <div>
                    <label class="block text-sm font-semibold">Carretel Substitu√≠do</label>
                    <select id="numeroCarretelComplementar" class="w-full border rounded px-3 py-2">
                        <option value="">Nenhum (opcional)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="cancelarParada" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Cancelar</button>
          <button type="submit" id="submitParadaBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar</button>
        </div>
      </form>

      <hr class="my-4" />

      <div>
        <h4 class="font-semibold mb-2">Hist√≥rico do dia</h4>
        <div id="historicoParadas" class="max-h-60 overflow-auto space-y-2 text-sm"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc,
    query, where, orderBy, serverTimestamp, onSnapshot, setDoc,
    enableMultiTabIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // ===== Vari√°veis Globais de Sess√£o e Estado =====
  let operadorLogado = null;
  let isAdmin = false;
  const SENHA_SECRETA_ADMIN = 'usco123';

  // ===== Configura√ß√£o do Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyCVLmT9ze8br21yZc7w3x6RyImy0_34NOk",
    authDomain: "irrigac-dc6ca.firebaseapp.com",
    projectId: "irrigac-dc6ca",
    storageBucket: "irrigac-dc6ca.firebasestorage.app",
    messagingSenderId: "410561274798",
    appId: "1:410561274798:web:4b2a494aefad676262de3f",
    measurementId: "G-9C2SDV3NNR"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== Persist√™ncia Offline =====
  enableMultiTabIndexedDbPersistence(db).catch(err => {
    if (err.code === 'failed-precondition') console.warn("Persist√™ncia offline n√£o habilitada: m√∫ltiplas abas abertas.");
    else if (err.code === 'unimplemented') console.warn("O navegador n√£o suporta persist√™ncia offline.");
    else console.warn("Erro ao habilitar persist√™ncia offline:", err);
  });

  // ===== Fun√ß√µes utilit√°rias =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fatorCarreador = 0.006;

  function showMessage(text, type = "success") {
    const msgEl = $("#mensagem");
    msgEl.textContent = text;
    const styles = {
      success: "bg-green-100 text-green-700 border border-green-400",
      error: "bg-red-100 text-red-700 border border-red-400",
      sync: "bg-blue-100 text-blue-700 border border-blue-400"
    };
    msgEl.className = `p-3 rounded mb-4 ${styles[type] || styles.success}`;
    msgEl.classList.remove("hidden");
    
    clearTimeout(showMessage._t);
    if (type !== "sync") {
      showMessage._t = setTimeout(() => msgEl.classList.add("hidden"), 5000);
    }
  }

    // LISTAS DE DADOS EST√ÅTICOS
    const codigosParada = ["937 - AGUARDANDO ELETRICISTA","957 - AGURDANDO MEC√ÇNICO INTERNO","903 - AGUARDANDO MEC√ÇNICO","961 - ENTUPIMENTO","913 - FALTA DE COMB. / LUBRIF.","960 - FALTA ENERGIA","919 - HOR√ÅRIO PONTA","921 - FALTA DE √ÅGUA","922 - FALTA DE VINHA√áA","911 - FALTA CAMINH√ÉO","963 - PARADA APLIC.ADUBO/HERB.","924 - FALTA DE OPERADOR","964 - FALTA TUBULA√á√ÉO","975 - FALTA √ÅREA","959 - LIMPEZA LAVAGEM DO EQP.","976 - PIVOTAGEM","977 - PARADA CONSERTO EXTERNO","978 - DESLIGAMENTO QUEIMA","979 - AGUARDANDO LIBERA√á√ÉO √ÅREA/CARREGAMENTO","948 - AGUARDANDO CARREGAR","982 - AGUARDANDO RECOLHimento CARRETEL","962 - DESCARREGANDO VINHA√áA","909 - ENTUPIMENTO/EMBUCHAMENTO","917 - REFEI√á√ÉO","942 - PARADA IND√öSTRIA","907 - CLIMA","904 - AGUARDANDO ORDENS","967 - AGUARDANDO P/MUDAN√áA","945 - REPARO ADUTORA","926 - FALTA TRATOR/TRANSBORDO","968 - TEMPO DE AVAN√áO","969 - LIMPEZA TUBULA√á√ÉO","970 - ASPERS√ÉO COMPLEMENTAR","972 - TEMPO APLIC.EXCEDIDO","974 - CARREGAMENTO VINHA√áA","929 - PARADA PROGRAMADA","916 - MUDAN√áA DE √ÅREA","973 - SOLICITA√á√ÉO EQP. CARREGAMENTO","966 - AGUARDANDO ORDENS USINA"];
    const problemasOpcoes = ["mangueira desacoplada", "mangueira rasgada/furada", "mangueira curta", "torre rachada", "girar torre", "torre sem abrir/fechar", "torre trocar pino", "torre trocar junta", "barulho no motor", "barulho na bomba", "vazamento na gaxeta", "vazamento no corpo da bomba", "eletro sem ligar/desligar", "botoeira quebrada", "desarmado", "pega press√£o e desliga", "taboca arriada", "cabo descascado", "eletro em curto", "taboca saindo fa√≠sca", "transformador sem fase", "correia do acoplamento quebrada", "rolamento da bomba", "rolamento do motor", "pneu furado/baixo", "mudan√ßa de transformador"];

    function todayYMD() { const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function toISOFromDatetimeLocal(v) { if (!v) return null; return new Date(v).toISOString(); }
    function fromISOToDatetimeLocal(iso) { if (!iso) return ""; const d = new Date(iso); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0, 16); }
    function formatDateTime(d) { try { return new Date(d).toLocaleString("pt-BR"); } catch { return "-"; } }

    function updateConnUI() {
      const online = navigator.onLine;
      $("#dotConexao").className = "inline-block w-3 h-3 rounded-full " + (online ? "bg-green-500" : "bg-orange-500");
      $("#txtConexao").textContent = online ? "Conectado" : "Offline";
    }
    window.addEventListener("online", updateConnUI);
    window.addEventListener("offline", updateConnUI);
    
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(err => console.warn("SW falhou:", err));
    }

    // ===== Seletores de DOM principais =====
    const COLLECTION = "Areas";
    const loginScreen = $("#loginScreen");
    const mainContent = $("main");
    const loginError = $("#loginError");
    const header = $("header");
    const sections = {
      projetos: $("#content-projetos"), cadastro: $("#content-cadastro"),
      operador: $("#content-operador"), relatorios: $("#content-relatorios"),
    };
    const selectProjeto = $("#projeto");
    const filtroProjetoCadastro = $("#filtroProjetoCadastro");
    const filtroProjetoOperador = $("#filtroProjetoOperador");
    const filtroProjetoRel = $("#filtroProjetoRel");
    const listaAreasCadastro = $("#listaAreasCadastro");
    const listaAreasOperador = $("#listaAreasOperador");
    const filtroDataOperador = $("#filtroDataOperador");
    const filtroDataRel = $("#filtroDataRel");
    const filtroAreaIndividual = $("#filtroAreaIndividual");
    
    // --- L√ìGICA DE NAVEGA√á√ÉO E ABAS ---
    const navContainer = $("#navContainer");
    const menuBtn = $("#menuAbasBtn");
    const menu = $("#menuAbas");
    const menuIcon = menuBtn.querySelector(".menu-icon");
    const desktopTabButtons = $$('nav[aria-label="Tabs"] > .tab-btn');

    menuBtn.addEventListener("click", () => {
      menu.classList.toggle("hidden");
      requestAnimationFrame(() => { menu.classList.toggle("show"); menuIcon.classList.toggle("open"); });
    });
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
        menu.classList.remove("show"); menuIcon.classList.remove("open");
        setTimeout(() => menu.classList.add("hidden"), 200);
      }
    });

    function atualizarMenuMobile(activeTabName) {
        const menuContainer = $("#menuAbas");
        const menuLabel = $("#menuAbasLabel");
        let menuHTML = ''; let activeLabelHTML = '';
        desktopTabButtons.forEach(btn => {
            const tabName = btn.dataset.tab;
            const isBloqueada = btn.classList.contains('aba-bloqueada');
            const btnContent = btn.innerHTML;
            if (tabName === activeTabName) activeLabelHTML = btnContent;
            else menuHTML += `<button data-tab="${tabName}" class="tab-btn ${isBloqueada ? 'aba-bloqueada' : ''} block w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-gray-100">${btnContent}</button>`;
        });
        menuLabel.innerHTML = activeLabelHTML;
        menuContainer.innerHTML = menuHTML;
    }
    
    navContainer.addEventListener('click', (e) => {
      const tabButton = e.target.closest('.tab-btn');
      if (tabButton && !tabButton.classList.contains('aba-bloqueada')) {
        const tabName = tabButton.dataset.tab;
        switchTab(tabName);
        if (menu.classList.contains('show')) {
            menu.classList.remove("show"); menuIcon.classList.remove("open");
            setTimeout(() => menu.classList.add("hidden"), 200);
        }
      }
    });

    function switchTab(name) {
      Object.entries(sections).forEach(([k, sec]) => sec.classList.toggle("hidden", k !== name));
      $$('.tab-btn').forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
      atualizarMenuMobile(name);
      if(operadorLogado || isAdmin) observarAreas();
    }
    
    let editDocId = null;
    let isSyncing = false;
    let syncNotificationShown = false;
    filtroDataOperador.value = todayYMD();
    filtroDataRel.value = todayYMD();
	
    // ===== L√ìGICA DE PROJETOS =====
// REMOVIDO: N√£o precisamos mais de um ID de documento fixo.
// const PROJ_DOC_ID = "6YqsO6D3ATYKiBNvuP9s";
// const projetoDocRef = doc(db, "Projeto", PROJ_DOC_ID);

// MODIFICADO: A refer√™ncia agora √© para a cole√ß√£o inteira.
const projetosCollectionRef = collection(db, "Projeto");
let projetosCache = []; // O cache agora ir√° armazenar objetos { id, nome }

// MODIFICADO: A l√≥gica do onSnapshot foi alterada para ler uma cole√ß√£o.
onSnapshot(query(projetosCollectionRef, orderBy("nome")), (snapshot) => {
    try {
        // Mapeia os documentos para o cache, armazenando o ID e o nome.
        projetosCache = snapshot.docs.map(doc => ({
            id: doc.id,
            nome: String(doc.data().nome || "").trim()
        })).filter(p => p.nome); // Filtra projetos sem nome

        preencherSelectsProjeto();
    } catch (e) {
        console.error("onSnapshot projetos:", e);
        showMessage("Erro ao observar projetos.", "error");
    }
}, (err) => {
    console.error("Snapshot projetos falhou:", err);
    showMessage("Erro ao carregar projetos.", "error");
});

function preencherSelectsProjeto() {
    const optsCadastro = ['<option value="">-- Selecione um Projeto --</option>'];
    const optsFiltro = ['<option value="">-- Todos os Projetos --</option>'];
    // MODIFICADO: Itera sobre o cache de objetos
    projetosCache.forEach(p => {
        optsCadastro.push(`<option value="${p.nome}">${p.nome}</option>`);
        optsFiltro.push(`<option value="${p.nome}">${p.nome}</option>`);
    });
    selectProjeto.innerHTML = optsCadastro.join("");
    filtroProjetoCadastro.innerHTML = optsFiltro.join("");
    filtroProjetoOperador.innerHTML = optsFiltro.join("");
    filtroProjetoRel.innerHTML = optsFiltro.join("");
    renderListaProjetosUI();
}

const listaProjetosEl = $("#listaProjetos");
function renderListaProjetosUI() {
    listaProjetosEl.innerHTML = "";
    if (!projetosCache.length) {
        listaProjetosEl.innerHTML = `<li class="text-sm text-gray-600">Nenhum projeto cadastrado.</li>`;
        return;
    }
    // MODIFICADO: Usa o objeto do cache que cont√©m id e nome.
    projetosCache.forEach((projeto) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between border rounded px-3 py-2";
        // Armazena o ID do documento nos bot√µes
        li.innerHTML = `<span>${projeto.nome}</span> <div class="flex gap-2"> <button class="btnRenomear bg-yellow-400 px-2 py-1 rounded text-sm" data-id="${projeto.id}" data-nome-atual="${projeto.nome}">Renomear</button> <button class="btnRemover bg-red-500 text-white px-2 py-1 rounded text-sm" data-id="${projeto.id}">Remover</button> </div>`;
        listaProjetosEl.appendChild(li);
    });

    // MODIFICADO: L√≥gica para Renomear um documento
    listaProjetosEl.querySelectorAll(".btnRenomear").forEach(btn => {
        btn.addEventListener("click", async () => {
            const docId = btn.dataset.id;
            const nomeAtual = btn.dataset.nomeAtual;
            const novoNome = prompt("Novo nome do projeto:", nomeAtual);
            if (!novoNome || !novoNome.trim() || novoNome.trim() === nomeAtual) return;

            try {
                // Atualiza o campo 'nome' do documento espec√≠fico
                await updateDoc(doc(db, "Projeto", docId), { nome: novoNome.trim() });
                showMessage("Projeto renomeado.");
            } catch(err) {
                console.error("Erro ao renomear projeto:", err);
                showMessage("Erro ao renomear o projeto.", "error");
            }
        });
    });

    // MODIFICADO: L√≥gica para Remover um documento
    listaProjetosEl.querySelectorAll(".btnRemover").forEach(btn => {
        btn.addEventListener("click", async () => {
            if (!confirm("Remover este projeto da lista?")) return;
            const docId = btn.dataset.id;
            try {
                // Deleta o documento espec√≠fico da cole√ß√£o
                await deleteDoc(doc(db, "Projeto", docId));
                showMessage("Projeto removido.");
            } catch(err) {
                console.error("Erro ao remover projeto:", err);
                showMessage("Erro ao remover o projeto.", "error");
            }
        });
    });
}

// REMOVIDO: A fun√ß√£o salvarProjetosList n√£o √© mais necess√°ria neste formato.
/*
async function salvarProjetosList(lista){ ... }
*/

// MODIFICADO: O formul√°rio agora adiciona um novo documento.
$("#formProjeto").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = $("#novoProjeto").value.trim();
    if (!nome) return showMessage("Informe o nome do projeto.", "error");

    // Verifica se o projeto j√° existe para evitar duplicatas
    if (projetosCache.some(p => p.nome.toLowerCase() === nome.toLowerCase())) {
        return showMessage("Este projeto j√° existe.", "error");
    }

    try {
        // Adiciona um novo documento √† cole√ß√£o 'Projeto'
        await addDoc(collection(db, "Projeto"), {
            nome: nome,
            criadoEm: serverTimestamp() // Opcional: para saber quando foi criado
        });
        $("#novoProjeto").value = "";
        showMessage("Projeto adicionado.");
    } catch (err) {
        console.error(err);
        showMessage("Erro ao salvar projeto.", "error");
    }
});



    // ===== L√≥gica de C√°lculo e Campos Din√¢micos (Cadastro) =====
    const horasPlanejadasInput = $("#horasPlanejadas"), velocidadeCarretelInput = $("#velocidadeCarretel"), metrosLinearesInput = $("#metrosLineares"), quantidadeCarreteisInput = $("#quantidadeCarreteis");
    function calcularMetrosLineares() {
      const metros = (parseFloat(horasPlanejadasInput.value) || 0) * (parseFloat(velocidadeCarretelInput.value) || 0) * (parseInt(quantidadeCarreteisInput.value, 10) || 0);
      metrosLinearesInput.value = metros.toFixed(2);
    }
    horasPlanejadasInput.addEventListener("input", calcularMetrosLineares);
    velocidadeCarretelInput.addEventListener("input", calcularMetrosLineares);
    quantidadeCarreteisInput.addEventListener("input", calcularMetrosLineares);
    
    const carreteisContainer = $("#carreteisContainer");
    quantidadeCarreteisInput.addEventListener('input', () => {
        carreteisContainer.innerHTML = '';
        for (let i = 1; i <= (parseInt(quantidadeCarreteisInput.value, 10) || 0); i++) {
            const div = document.createElement('div');
            div.innerHTML = `<label for="numeroCarretel_${i}" class="block text-sm font-semibold mb-1">N¬∞ Carretel ${i}</label><input id="numeroCarretel_${i}" data-index="${i}" required class="w-full border rounded px-3 py-2 numero-carretel-dinamico" placeholder="Ex: 13800${i}" />`;
            carreteisContainer.appendChild(div);
        }
    });

    
// MODIFICADO: (william - 28/08)
// ===== L√≥gica Principal de Dados (√Åreas) =====
let unsubscribeAreas = null;
    function observarAreas() {
        if (unsubscribeAreas) unsubscribeAreas();

        // MODIFICADO: A refer√™ncia base √† cole√ß√£o. 
        let areasQuery = collection(db, COLLECTION);

        // MODIFICADO: Adiciona o filtro de seguran√ßa se o usu√°rio n√£o for admin.
        // Ele s√≥ buscar√° documentos onde o campo 'projeto' est√° na lista de projetos do operador.
        if (operadorLogado && !isAdmin && Array.isArray(operadorLogado.projetos) && operadorLogado.projetos.length > 0) {
            areasQuery = query(areasQuery, where("projeto", "in", operadorLogado.projetos));
        } else if (operadorLogado && !isAdmin) {
            // Se o operador n√£o tem projetos listados, n√£o damos acesso a nada por seguran√ßa.
            // Criamos uma consulta que nunca retornar√° resultados.
             areasQuery = query(areasQuery, where("projeto", "==", "acesso_negado_sem_projeto_definido"));
        }
        // Se for admin, a consulta original sem filtros √© usada, retornando tudo.

        unsubscribeAreas = onSnapshot(areasQuery, (snapshot) => { // A consulta filtrada √© usada aqui
            const hasPending = snapshot.metadata.hasPendingWrites;
            const fromCache = snapshot.metadata.fromCache;
            if (hasPending) { showMessage("Altera√ß√µes salvas localmente. Sincronizando...", "sync"); isSyncing = true; syncNotificationShown = false; }
            else if (isSyncing && !fromCache && !syncNotificationShown) { showMessage("Dados sincronizados com sucesso! ‚úîÔ∏è", "success"); isSyncing = false; syncNotificationShown = true; }

            const areasData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            popularFiltroAreaIndividual(areasData);

            // As fun√ß√µes abaixo agora receber√£o apenas os dados j√° filtrados pelo snapshot
            if (!sections.cadastro.classList.contains("hidden")) listarAreasCadastro(snapshot);
            if (!sections.operador.classList.contains("hidden")) listarAreasOperador();
        }, (err) => { console.error("Falha ao observar √°reas:", err); showMessage("N√£o foi poss√≠vel carregar os dados.", "error"); });
    }

    async function toggleFinalizadaStatus(docId, newStatus) {
        const isFinalizing = newStatus === true;
        const today = new Date().toLocaleDateString('pt-BR'); 
        if (!confirm(isFinalizing ? "Finalizar a irriga√ß√£o para esta √°rea?" : "Reativar a irriga√ß√£o para esta √°rea?")) return;

        const dateInput = prompt(isFinalizing ? "Insira a data de fechamento:" : "Insira a data de reabertura:", today);
        if (!dateInput) { showMessage("A√ß√£o cancelada.", "error"); return; }

        const payload = { finalizada: newStatus };
        if (isFinalizing) { payload.dataFechamento = dateInput; payload.dataAbertura = null; }
        else { payload.dataAbertura = dateInput; payload.dataFechamento = null; }

        try {
            await updateDoc(doc(db, COLLECTION, docId), payload);
            showMessage(isFinalizing ? "√Årea finalizada." : "√Årea reativada.");
        } catch (e) { console.error(e); showMessage("Erro ao alterar status da √°rea.", "error"); }
    }

    async function listarAreasCadastro(snapshot) {
        listaAreasCadastro.innerHTML = `<div class="text-sm text-gray-600">Carregando...</div>`;
        try {
            const snap = snapshot || await getDocs(collection(db, COLLECTION));
            const filtro = (filtroProjetoCadastro.value || "").trim();
            const frag = document.createDocumentFragment();
            let count = 0;

            snap.forEach(docSnap => {
                const data = docSnap.data();
                if (operadorLogado && !isAdmin && operadorLogado.projetos && !operadorLogado.projetos.includes(data.projeto)) return;
                if (filtro && data.projeto !== filtro) return;

                const isFinalizada = data.finalizada === true;
                const card = document.createElement("div");
                card.className = `bg-white rounded shadow p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 ${isFinalizada ? 'opacity-60 bg-gray-50' : ''}`;
                const carreteisStr = Array.isArray(data.carreteis) ? data.carreteis.join(', ') : (data.numeroCarretel || '-');
                const buttonsHTML = isFinalizada
                ? `<button class="btnReativar w-full bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-id="${docSnap.id}">Reativar</button><button class="btnEditar bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-400" data-id="${docSnap.id}">Editar</button>`
                : `<button class="btnEditar bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-400" data-id="${docSnap.id}">Editar</button><button class="btnFinalizar bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-id="${docSnap.id}">Finalizar</button>`;
                let statusDateHTML = '';
                if (isFinalizada && data.dataFechamento) statusDateHTML = `<div class="text-xs text-red-700 font-medium mt-1"><strong>Fechado em:</strong> ${data.dataFechamento}</div>`;
                else if (!isFinalizada && data.dataAbertura) statusDateHTML = `<div class="text-xs text-green-700 font-medium mt-1"><strong>Aberto em:</strong> ${data.dataAbertura}</div>`;
                card.innerHTML = `<div class="flex-1 flex flex-col gap-1 text-sm"><div class="flex items-center gap-4"><span class="font-semibold text-base text-blue-900">${data.bloco || "-"}</span>${isFinalizada ? '<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">FINALIZADA</span>' : ''}</div>${statusDateHTML}<div><strong>Projeto:</strong> ${data.projeto || "-"}</div><div><strong>Bombeamento:</strong> ${data.bombeamento || "-"}</div><div><strong>Carretel(√©is):</strong> ${carreteisStr}</div><div><strong>Velocidade:</strong> ${data.velocidadeCarretel || "-"} m/h</div><div><strong>ML (Plano):</strong> ${data.metrosLineares || "-"} m</div><div><strong>Vaz√£o:</strong> ${data.vazao || "-"}</div><div><strong>Croqui:</strong> ${data.numeroCroqui || "-"}</div><div><strong>Pr√≥x. Bloco:</strong> ${data.proxBloco || "-"}</div></div><div class="flex flex-col gap-2 w-full md:w-auto self-stretch justify-end">${buttonsHTML}<button class="btnExcluir bg-red-400 text-white px-3 py-1 rounded hover:bg-gray-500" data-id="${docSnap.id}">Excluir</button></div>`;
                frag.appendChild(card);
                count++;
            });
            listaAreasCadastro.innerHTML = "";
            listaAreasCadastro.appendChild(frag);
            listaAreasCadastro.querySelectorAll(".btnFinalizar").forEach(b => b.addEventListener("click", () => toggleFinalizadaStatus(b.dataset.id, true)));
            listaAreasCadastro.querySelectorAll(".btnReativar").forEach(b => b.addEventListener("click", () => toggleFinalizadaStatus(b.dataset.id, false)));
            listaAreasCadastro.querySelectorAll(".btnEditar").forEach(b => b.addEventListener("click", () => carregarParaEdicao(b.dataset.id)));
            listaAreasCadastro.querySelectorAll(".btnExcluir").forEach(b => b.addEventListener("click", async () => {
                if (!confirm("EXCLUIR esta √°rea? A a√ß√£o n√£o pode ser desfeita.")) return;
                try { await deleteDoc(doc(db, COLLECTION, b.dataset.id)); showMessage("√Årea exclu√≠da."); } catch (e) { console.error(e); showMessage("Erro ao excluir √°rea.", "error"); }
            }));
            if (!count) listaAreasCadastro.innerHTML = `<div class="text-sm text-gray-600">Nenhuma √°rea para o filtro.</div>`;
        } catch (e) { console.error(e); listaAreasCadastro.innerHTML = `<div class="text-sm text-red-600">Erro ao carregar √°reas.</div>`; }
    }

async function carregarParaEdicao(id) {
    try {
        const snap = await getDoc(doc(db, COLLECTION, id));
        if (!snap.exists()) return showMessage("√Årea n√£o encontrada.", "error");
        const d = snap.data();
        $("#formArea").reset(); carreteisContainer.innerHTML = '';
        $("#projeto").value = d.projeto || ""; $("#bombeamento").value = d.bombeamento || "";
        $("#bloco").value = d.bloco || ""; $("#proxBloco").value = d.proxBloco || "";
        $("#numeroEletrobomba").value = d.numeroEletrobomba || ""; $("#redeEletrica").value = d.redeEletrica || "";
        const qtdCarreteis = d.quantidadeCarreteis || (Array.isArray(d.carreteis) ? d.carreteis.length : 1);
        quantidadeCarreteisInput.value = qtdCarreteis;
        quantidadeCarreteisInput.dispatchEvent(new Event('input'));
        setTimeout(() => {
          if (Array.isArray(d.carreteis)) d.carreteis.forEach((num, index) => { const input = $(`#numeroCarretel_${index + 1}`); if (input) input.value = num; });
          else if (d.numeroCarretel) { const input = $(`#numeroCarretel_1`); if (input) input.value = d.numeroCarretel; }
        }, 0);
        $("#tipoArea").value = d.tipoArea || ""; $("#tipoIrrigacao").value = d.tipoIrrigacao || "";
        $("#tipoProduto").value = d.tipoProduto || ""; $("#horasPlanejadas").value = Number(d.horasPlanejadas || 0);
        $("#velocidadeCarretel").value = Number(d.velocidadeCarretel || 0); $("#numeroCroqui").value = d.numeroCroqui || "";
        $("#vazao").value = d.vazao || ""; calcularMetrosLineares();
        editDocId = id; $("#cancelarEdicao").classList.remove("hidden");
        switchTab("cadastro"); showMessage("√Årea carregada para edi√ß√£o.");
    } catch (e) { console.error(e); showMessage("Erro ao carregar √°rea.", "error"); }
}

    $("#cancelarEdicao").addEventListener("click", () => {
        editDocId = null; $("#formArea").reset();
        carreteisContainer.innerHTML = ''; $("#cancelarEdicao").classList.add("hidden");
    });

    $("#formArea").addEventListener("submit", async (e) => {
        e.preventDefault();
        const carreteis = $$(".numero-carretel-dinamico").map(input => input.value.trim());
        if (carreteis.some(c => !c)) return showMessage("Preencha o n√∫mero de todos os carret√©is.", "error");

        const payload = {
            projeto: $("#projeto").value.trim(), bombeamento: $("#bombeamento").value.trim(), bloco: $("#bloco").value.trim(),
            proxBloco: $("#proxBloco").value.trim(), numeroEletrobomba: $("#numeroEletrobomba").value.trim(), redeEletrica: $("#redeEletrica").value.trim(),
            quantidadeCarreteis: Number(quantidadeCarreteisInput.value || 0), carreteis: carreteis, tipoArea: $("#tipoArea").value.trim(),
            tipoIrrigacao: $("#tipoIrrigacao").value.trim(), tipoProduto: $("#tipoProduto").value.trim(), horasPlanejadas: Number($("#horasPlanejadas").value || 0),
            velocidadeCarretel: Number($("#velocidadeCarretel").value || 0), metrosLineares: Number($("#metrosLineares").value || 0),
            numeroCroqui: $("#numeroCroqui").value.trim(), vazao: $("#vazao").value.trim(), atualizadoEm: new Date().toISOString()
        };
        delete payload.numeroCarretel; // Remove campo antigo
        if (Array.from($("#formArea").querySelectorAll("[required]")).some(i => !i.value.trim())) return showMessage("Preencha todos os campos obrigat√≥rios.", "error");

        try {
            if (editDocId) {
                await updateDoc(doc(db, COLLECTION, editDocId), payload); showMessage("√Årea atualizada.");
            } else {
                payload.criadoEm = new Date().toISOString(); payload.finalizada = false; 
                await addDoc(collection(db, COLLECTION), payload); showMessage("√Årea cadastrada.");
            }
            editDocId = null; $("#formArea").reset();
            carreteisContainer.innerHTML = ''; $("#cancelarEdicao").classList.add("hidden");
        } catch (e) { console.error(e); showMessage("Erro ao salvar √°rea.", "error"); }
    });

    filtroProjetoCadastro.addEventListener("change", () => listarAreasCadastro());

    $("#btnFiltrarOperador").addEventListener("click", listarAreasOperador);
    
    async function listarAreasOperador() {
      listaAreasOperador.innerHTML = `<div class="text-sm text-gray-600">Carregando...</div>`;
      try {
        const ymd = filtroDataOperador.value || todayYMD();
        const snap = await getDocs(collection(db, COLLECTION));
        const filtroProj = (filtroProjetoOperador.value || "").trim();
        const cards = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          if (operadorLogado && !isAdmin && operadorLogado.projetos && !operadorLogado.projetos.includes(data.projeto)) return;
          if (data.finalizada === true) return;
          if (filtroProj && data.projeto !== filtroProj) return;
          cards.push({ id: docSnap.id, ...data });
        });

        if (cards.length === 0) { listaAreasOperador.innerHTML = `<div class="text-sm text-gray-600">Nenhuma √°rea ativa para os filtros.</div>`; return; }
        
        const frag = document.createDocumentFragment();
        for (const area of cards) {
          const card = document.createElement("div");
          card.className = "bg-white rounded shadow p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4";
          const statusEl = document.createElement("div");
          statusEl.className = "text-xs"; statusEl.textContent = "verificando...";
          (async () => {
            const st = await getStatusDia(area.id, ymd); const badge = document.createElement("span");
            badge.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium";
            if (st === "com_parada") { badge.className += " bg-red-100 text-red-800"; badge.textContent = "Com parada"; }
            else if (st === "sem_parada") { badge.className += " bg-green-100 text-green-800"; badge.textContent = "Sem parada"; }
            else if (st === "com_complementar") { badge.className += " bg-sky-100 text-sky-800"; badge.textContent = "Com Irrig. Complementar"; }
            else { badge.className += " bg-gray-100 text-gray-800"; badge.textContent = "Sem registros"; }
            statusEl.innerHTML = ""; statusEl.appendChild(badge);
          })();
          const carreteisStr = Array.isArray(area.carreteis) ? area.carreteis.join(', ') : (area.numeroCarretel || '-');
          card.innerHTML = `<div class="text-sm"><div class="font-semibold text-base text-blue-900">${area.bloco || "-"}</div><div><strong>Projeto:</strong> ${area.projeto || "-"}</div><div><strong>Bombeamento:</strong> ${area.bombeamento || "-"}</div><div><strong>Carretel(√©is):</strong> ${carreteisStr}</div><div><strong>Velocidade:</strong> ${area.velocidadeCarretel || "-"} m/h</div><div><strong>ML (Plano):</strong> ${area.metrosLineares || "-"} m</div><div><strong>Vaz√£o:</strong> ${area.vazao || "-"}</div><div><strong>H. Plan.:</strong> ${Number(area.horasPlanejadas||0)}</div><div><strong>Croqui:</strong> ${area.numeroCroqui || "-"}</div><div><strong>Pr√≥x. Bloco:</strong> ${area.proxBloco || "-"}</div></div><div class="flex flex-col md:items-end gap-2 w-full md:w-auto"><div class="mb-1" id="statusWrap"></div><button class="btnAddParada bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full md:w-auto">+ Registrar Atividade</button><button class="btnVerHistorico bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 w-full md:w-auto">Hist√≥rico (${ymd})</button></div>`;
          card.querySelector("#statusWrap").appendChild(statusEl);
          card.querySelector(".btnAddParada").addEventListener("click", () => abrirModal(area));
          card.querySelector(".btnVerHistorico").addEventListener("click", () => abrirModal(area));
          frag.appendChild(card);
        }
        listaAreasOperador.innerHTML = ""; listaAreasOperador.appendChild(frag);
      } catch (e) { console.error(e); listaAreasOperador.innerHTML = `<div class="text-sm text-red-600">Erro ao carregar √°reas.</div>`; }
    }
    
    // ===== MODAL DE REGISTRO DE ATIVIDADE =====
    const modalParada = $("#modalParada"), closeModalBtn = $("#closeModal"), cancelarParadaBtn = $("#cancelarParada"), formParada = $("#formParada"), camposRegistro = $("#camposRegistro"), detalhesParada = $("#detalhesParada"), detalhesComplementar = $("#detalhesComplementar"), duracaoParadaEl = $("#duracaoParada"), overlapAlert = $("#alertOverlap"), selecaoCarretelParadaDiv = $("#selecaoCarretelParada"), infoRedeEletricaDiv = $("#infoRedeEletrica"), codParadaSelect = $("#codParada");
    let areaAtual = null, editParadaId = null; 

    formParada.querySelectorAll('input[name="tipoRegistro"]').forEach(r => r.addEventListener("change", (ev) => {
        const val = ev.target.value;
        camposRegistro.classList.toggle("hidden", val === "sem_parada");
        detalhesParada.classList.toggle("hidden", val !== "parada");
        detalhesComplementar.classList.toggle("hidden", val !== "complementar");
    }));

    codParadaSelect.addEventListener('change', (e) => {
        const selection = e.target.value, input = $("#equipamentoProblemaModal");
        selecaoCarretelParadaDiv.classList.add('hidden'); infoRedeEletricaDiv.classList.add('hidden'); input.value = '';
        if (selection === 'E') {
            if (areaAtual?.numeroEletrobomba) { infoRedeEletricaDiv.innerHTML = `<strong>N¬∞ Eletrobomba:</strong> ${areaAtual.numeroEletrobomba}`; input.value = areaAtual.numeroEletrobomba; infoRedeEletricaDiv.classList.remove('hidden'); }
        } else if (selection === 'R') {
            if (areaAtual?.redeEletrica) { infoRedeEletricaDiv.innerHTML = `<strong>Rede El√©trica:</strong> ${areaAtual.redeEletrica}`; input.value = areaAtual.redeEletrica; infoRedeEletricaDiv.classList.remove('hidden'); }
        } else if (selection === 'C') {
            selecaoCarretelParadaDiv.classList.remove('hidden');
        }
    });

    $("#numeroCarretelParada").addEventListener('change', (e) => { $("#equipamentoProblemaModal").value = e.target.value; });

    function calcularDuracaoModal() {
      overlapAlert.classList.add("hidden");
      const di = new Date($("#inicioParada").value), df = new Date($("#fimParada").value);
      if (isNaN(di) || isNaN(df) || df <= di) { duracaoParadaEl.textContent = "-"; return 0; }
      const min = (df - di) / 60000;
      duracaoParadaEl.textContent = `${min.toFixed(0)} min (${(min/60).toFixed(2)} h)`; return min / 60;
    }
    $("#inicioParada").addEventListener("input", calcularDuracaoModal);
    $("#fimParada").addEventListener("input", calcularDuracaoModal);
    
    const problemaOutroCheckbox = $("#problemaOutro"), descricaoProblemaOutroTextarea = $("#descricaoProblemaOutro");
    problemaOutroCheckbox.addEventListener('change', () => { descricaoProblemaOutroTextarea.classList.toggle('hidden', !problemaOutroCheckbox.checked); });

    function abrirModal(areaDoc, paradaParaEditar = null) {
      areaAtual = areaDoc; editParadaId = paradaParaEditar ? paradaParaEditar.id : null;
      $("#modalTitle").textContent = editParadaId ? "Editar Registro" : "Registrar Atividade Di√°ria";
      $("#submitParadaBtn").textContent = editParadaId ? "Salvar Altera√ß√µes" : "Salvar";
      $("#modalInfoArea").innerHTML = `<div><strong>Projeto:</strong> ${areaDoc.projeto || "-"}</div><div><strong>Bloco:</strong> ${areaDoc.bloco || "-"}</div>`;
      formParada.reset();
      selecaoCarretelParadaDiv.classList.add('hidden'); infoRedeEletricaDiv.classList.add('hidden');
      $('input[name="tipoRegistro"][value="sem_parada"]').checked = true;
      descricaoProblemaOutroTextarea.value = ''; descricaoProblemaOutroTextarea.classList.add('hidden');
      camposRegistro.classList.add("hidden"); detalhesParada.classList.add("hidden"); detalhesComplementar.classList.add("hidden");
      duracaoParadaEl.textContent = "-"; overlapAlert.classList.add("hidden");

      const selCarretelParada = $("#numeroCarretelParada"), selCarretelComp = $("#numeroCarretelComplementar");
      selCarretelParada.innerHTML = '<option value="">Selecione o Carretel</option>';
      selCarretelComp.innerHTML = '<option value="">Nenhum (opcional)</option>';
      if(Array.isArray(areaDoc.carreteis) && areaDoc.carreteis.length > 0) {
          areaDoc.carreteis.forEach((num, index) => {
              const option = document.createElement('option'); option.value = num; option.textContent = `Carretel ${index + 1}: ${num}`;
              selCarretelParada.appendChild(option.cloneNode(true)); selCarretelComp.appendChild(option.cloneNode(true));
          });
      }
      
      if (paradaParaEditar) {
          const p = paradaParaEditar; const tipo = p.tipoRegistro || (p.houveParada ? 'parada' : 'sem_parada');
          $('input[name="tipoRegistro"][value="'+tipo+'"]').checked = true;
          if(tipo !== 'sem_parada'){
            camposRegistro.classList.remove("hidden");
            detalhesParada.classList.toggle("hidden", tipo !== "parada");
            detalhesComplementar.classList.toggle("hidden", tipo !== "complementar");
            $("#inicioParada").value = fromISOToDatetimeLocal(p.inicioParada); $("#fimParada").value = fromISOToDatetimeLocal(p.fimParada);
            calcularDuracaoModal();
            if(tipo === 'parada'){
              $("#codParada").value = p.codParada || "";
              if (p.codParada === 'C') { selecaoCarretelParadaDiv.classList.remove('hidden'); $("#numeroCarretelParada").value = p.numeroCarretelParado || ""; }
              $("#horimetroInicial").value = p.horimetroInicial || ""; $("#horimetroFinal").value = p.horimetroFinal || "";
              $("#equipamentoProblemaModal").value = p.equipamentoProblema || ""; $("#descricaoParadaCodigoSelect").value = p.descricaoParadaCodigo || "";
              $$('input[name="problema"]').forEach(cb => cb.checked = false);
              if (Array.isArray(p.descricaoProblema)) p.descricaoProblema.forEach(prob => { const cb = $(`input[name="problema"][value="${prob}"]`); if (cb) cb.checked = true; });
              if (p.descricaoProblemaOutro) { problemaOutroCheckbox.checked = true; descricaoProblemaOutroTextarea.value = p.descricaoProblemaOutro; descricaoProblemaOutroTextarea.classList.remove('hidden'); }
            } else if (tipo === 'complementar') { $("#numeroCarretelComplementar").value = p.numeroCarretelParado || ""; }
          }
      } else {
          const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          const in30 = new Date(now); in30.setMinutes(in30.getMinutes() + 30);
          $("#inicioParada").value = now.toISOString().slice(0,16); $("#fimParada").value = in30.toISOString().slice(0,16);
      }
      modalParada.classList.remove("hidden"); modalParada.classList.add("flex");
      carregarHistoricoParadas(areaDoc.id, filtroDataOperador.value);
    }

    function fecharModal(){ modalParada.classList.add("hidden"); modalParada.classList.remove("flex"); areaAtual = null; editParadaId = null; }
    closeModalBtn.addEventListener("click", fecharModal);
    cancelarParadaBtn.addEventListener("click", fecharModal);
    modalParada.addEventListener("click", (e) => { if (e.target === modalParada) fecharModal(); });

    async function carregarHistoricoParadas(areaId, ymd) {
      const cont = $("#historicoParadas"); cont.innerHTML = `<div class="text-gray-600 text-sm">Carregando...</div>`;
      try {
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const qy = query(ref, where("inicioParada", ">=", `${ymd}T00:00:00`), where("inicioParada", "<=", `${ymd}T23:59:59`), orderBy("inicioParada", "asc"));
        const snap = await getDocs(qy);
        if (snap.empty) { cont.innerHTML = `<div class="text-gray-600 text-sm">Sem registros para o dia.</div>`; return []; }
        
        const itens = snap.docs.map(s => ({ id: s.id, ...s.data() }));
        const frag = document.createDocumentFragment();
        itens.forEach(p => {
            const linha = document.createElement("div");
            const durh = p.duracaoHoras != null ? Number(p.duracaoHoras).toFixed(2) : "-";
            const tipo = p.tipoRegistro || (p.houveParada ? 'parada' : 'sem_parada');
            let tipoLabel = '';
            if (tipo === 'parada') tipoLabel = '<strong class="text-red-600">Parada</strong>';
            else if (tipo === 'complementar') tipoLabel = '<strong class="text-cyan-600">Irriga√ß√£o Complementar</strong>';
            else tipoLabel = '<strong>Opera√ß√£o Normal</strong>';
            let detalhesHTML = '';
            if (tipo === 'parada') {
              const descricoes = (Array.isArray(p.descricaoProblema) && p.descricaoProblema.length > 0 ? p.descricaoProblema.join(', ') : "N/A") + (p.descricaoProblemaOutro ? `; Outro: ${p.descricaoProblemaOutro}` : '');
              const equipamento = p.codParada === 'C' ? `Carretel ${p.numeroCarretelParado || ''}` : `${p.codParada || "-"} ${p.equipamentoProblema ? "‚Ä¢ " + p.equipamentoProblema : ""}`;
              detalhesHTML = `<div><strong>Equip.:</strong> ${equipamento}</div><div><strong>C√≥d. Parada:</strong> ${p.descricaoParadaCodigo || "-"}</div><div><strong>Problema(s):</strong> ${descricoes}</div><div><strong>In√≠cio:</strong> ${formatDateTime(p.inicioParada)} ‚Ä¢ <strong>Fim:</strong> ${formatDateTime(p.fimParada)}</div><div><strong>Dura√ß√£o:</strong> ${durh} h</div><div><strong>Hor√≠metro:</strong> ${p.horimetroInicial || "-"} at√© ${p.horimetroFinal || "-"}</div>`;
            } else if (tipo === 'complementar') {
               detalhesHTML = `${p.numeroCarretelParado ? `<div><strong>Carretel Substituto:</strong> ${p.numeroCarretelParado}</div>` : ''}<div><strong>In√≠cio:</strong> ${formatDateTime(p.inicioParada)} ‚Ä¢ <strong>Fim:</strong> ${formatDateTime(p.fimParada)}</div><div><strong>Dura√ß√£o:</strong> ${durh} h</div>`;
            }
            const infoRegistro = (p.operadorNome && p.operadorMatricula) ? `<div class="text-xs text-gray-500"><em>Registrado por: ${p.operadorNome} (${p.operadorMatricula})</em></div>` : '';
            const adminButtons = isAdmin ? `<div class="flex gap-2 mt-2"><button class="btnEditarParada text-xs bg-yellow-400 text-white px-2 py-1 rounded" data-parada-id="${p.id}">Editar</button><button class="btnExcluirParada text-xs bg-red-500 text-white px-2 py-1 rounded" data-parada-id="${p.id}">Excluir</button></div>` : '';
            linha.className = "border rounded p-2";
            linha.innerHTML = `<div><strong>Tipo:</strong> ${tipoLabel}</div>${detalhesHTML}<div class="text-xs text-gray-500"><em>Registrado em:</em> ${p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleString("pt-BR") : "-"}</div>${infoRegistro}${adminButtons}`;
            frag.appendChild(linha);
        });
        cont.innerHTML = ""; cont.appendChild(frag);
        cont.querySelectorAll('.btnEditarParada').forEach(btn => btn.addEventListener('click', () => { const p = itens.find(item => item.id === btn.dataset.paradaId); if (p) abrirModal(areaAtual, p); }));
        cont.querySelectorAll('.btnExcluirParada').forEach(btn => btn.addEventListener('click', () => excluirParada(areaId, btn.dataset.paradaId)));
        return itens;
      } catch (e) { console.error(e); cont.innerHTML = `<div class="text-red-600 text-sm">Erro ao carregar hist√≥rico.</div>`; return []; }
    }

    async function excluirParada(areaId, paradaId) {
        if (!confirm("Excluir este registro?")) return;
        try {
            await deleteDoc(doc(db, COLLECTION, areaId, "paradas", paradaId));
            showMessage("Registro exclu√≠do."); carregarHistoricoParadas(areaId, filtroDataOperador.value);
        } catch (e) { console.error("Erro ao excluir registro:", e); showMessage("Erro ao excluir.", "error"); }
    }

    function existeSobreposicao(registros, novoInicioIso, novoFimIso, idSendoEditado) {
      const ni = new Date(novoInicioIso).getTime(), nf = new Date(novoFimIso).getTime();
      return registros.some(r => {
        if (r.id === idSendoEditado || !r.inicioParada) return false;
        const ri = new Date(r.inicioParada).getTime(), rf = new Date(r.fimParada).getTime();
        return ni < rf && nf > ri;
      });
    }

formParada.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!areaAtual?.id) return showMessage("√Årea inv√°lida.", "error");
    const submitBtn = $("#submitParadaBtn"); submitBtn.disabled = true; submitBtn.textContent = "Salvando...";

    try {
        const tipoRegistro = formParada.querySelector('input[name="tipoRegistro"]:checked').value;
        let payload = { createdAt: serverTimestamp(), tipoRegistro };
        if (operadorLogado) {
            payload.operadorNome = operadorLogado.nome;
            payload.operadorMatricula = operadorLogado.matricula;
        }

        if (tipoRegistro === 'sem_parada') {
            payload.houveParada = false;
        } else {
            const ymdFiltro = $("#filtroDataOperador").value;
            const horaInicio = $("#inicioParada").value.split('T')[1], horaFim = $("#fimParada").value.split('T')[1];
            const inicioCorreto = `${ymdFiltro}T${horaInicio}`, fimCorreto = `${ymdFiltro}T${horaFim}`;
            const di = new Date(inicioCorreto), df = new Date(fimCorreto);
            if (isNaN(di) || isNaN(df) || df <= di) throw new Error("Verifique os hor√°rios de in√≠cio e t√©rmino.");

            const inicioIso = toISOFromDatetimeLocal(inicioCorreto), fimIso = toISOFromDatetimeLocal(fimCorreto);
            const historico = await carregarHistoricoParadas(areaAtual.id, ymdFiltro);
            if (existeSobreposicao(historico, inicioIso, fimIso, editParadaId)) { overlapAlert.classList.remove("hidden"); throw new Error("Intervalo sobrep√µe registro existente."); }
            
            payload = { ...payload, houveParada: tipoRegistro === 'parada', inicioParada: inicioIso, fimParada: fimIso, duracaoHoras: Number(((df - di) / 3600000).toFixed(2)) };

            if (tipoRegistro === 'parada') {
                if ($("#codParada").value === 'C' && !$("#numeroCarretelParada").value) throw new Error("Selecione o carretel com parada.");
                const descricoes = Array.from($$('input[name="problema"]:checked')).map(cb => cb.value);
                const outro = problemaOutroCheckbox.checked ? descricaoProblemaOutroTextarea.value.trim() : "";
                if (!$("#codParada").value || !$("#descricaoParadaCodigoSelect").value) throw new Error("Verifique tipo de equipamento e c√≥digo da parada.");
                if (descricoes.length === 0 && !outro) throw new Error("Selecione um problema ou descreva em 'Outro'.");
                payload = { ...payload, codParada: $("#codParada").value, numeroCarretelParado: $("#numeroCarretelParada").value || null, descricaoParadaCodigo: $("#descricaoParadaCodigoSelect").value, descricaoProblema: descricoes, descricaoProblemaOutro: outro, equipamentoProblema: $("#equipamentoProblemaModal").value.trim(), horimetroInicial: $("#horimetroInicial").value.trim() || null, horimetroFinal: $("#horimetroFinal").value.trim() || null };
            } else if (tipoRegistro === 'complementar') {
                payload.numeroCarretelParado = $("#numeroCarretelComplementar").value || null;
            }
        }
        
        if (editParadaId) await updateDoc(doc(db, COLLECTION, areaAtual.id, "paradas", editParadaId), payload);
        else await addDoc(collection(doc(db, COLLECTION, areaAtual.id), "paradas"), payload);
        
        showMessage(navigator.onLine ? (editParadaId ? "Registro atualizado!" : "Registro salvo!") : "Salvo localmente! Sincronizando...", navigator.onLine ? "success" : "sync");
        fecharModal();
    } catch (e) {
        console.error(e); showMessage(e.message || "Erro ao salvar registro.", "error");
    } finally {
        submitBtn.disabled = false; submitBtn.textContent = editParadaId ? "Salvar Altera√ß√µes" : "Salvar";
    }
});


    async function getStatusDia(areaId, ymd) {
      try {
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const qy = query(ref,  where("inicioParada", ">=", `${ymd}T00:00:00`),  where("inicioParada", "<=", `${ymd}T23:59:59`));
        const snap = await getDocs(qy);
        if (snap.empty) return "sem_registro";
        let comParada = false, comComplementar = false;
        snap.forEach(s => { const d = s.data(); if (d.houveParada) comParada = true; if (d.tipoRegistro === 'complementar') comComplementar = true; });
        if(comParada) return "com_parada";
        if(comComplementar) return "com_complementar";
        return "sem_parada";
      } catch (e) { console.error("status dia erro:", e); return "sem_registro"; }
    }

    // ===== EXPORTA√á√ïES (CSV/PDF) =====
    $("#btnExportCSV").addEventListener("click", async () => { const ymd = filtroDataOperador.value || todayYMD(); const dados = await coletarParadasDia(ymd); downloadBlob(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), toCSV(dados, true)], { type: "text/csv;charset=utf-8;" }), `paradas_${ymd}.csv`); });
    $("#btnExportPDF").addEventListener("click", async () => { const ymd = filtroDataOperador.value || todayYMD(); const dados = await coletarParadasDia(ymd); gerarPDF(dados, ymd, "Relat√≥rio de Paradas"); });

    async function coletarParadasDia(ymd) {
      const start = new Date(ymd + "T00:00:00.000Z"), end = new Date(ymd + "T23:59:59.999Z");

      // MODIFICADO: In√≠cio da constru√ß√£o da consulta
      let areasQuery = collection(db, COLLECTION);
      if (operadorLogado && !isAdmin && Array.isArray(operadorLogado.projetos) && operadorLogado.projetos.length > 0) {
          areasQuery = query(areasQuery, where("projeto", "in", operadorLogado.projetos));
      } else if (operadorLogado && !isAdmin) {
          areasQuery = query(areasQuery, where("projeto", "==", "acesso_negado_sem_projeto_definido"));
      }
      const areasSnap = await getDocs(areasQuery); // Usa a consulta filtrada
      // FIM DA MODIFICA√á√ÉO

      const all = [];
      for (const areaDoc of areasSnap.docs) {
        const area = areaDoc.data();
        // A verifica√ß√£o abaixo se torna redundante, mas podemos manter por seguran√ßa extra.
        if (operadorLogado && !isAdmin && operadorLogado.projetos && !operadorLogado.projetos.includes(area.projeto)) continue;
        const ref = collection(doc(db, COLLECTION, areaDoc.id), "paradas");
        const qy = query(ref, where("inicioParada", ">=", start.toISOString()), where("inicioParada", "<=", end.toISOString()), orderBy("inicioParada", "asc"));
        const paradasSnap = await getDocs(qy);
        const carreteisStr = Array.isArray(area.carreteis) ? area.carreteis.join('; ') : area.numeroCarretel || '';
        if (paradasSnap.empty) { all.push({ projeto: area.projeto || "", bloco: area.bloco || "", bombeamento: area.bombeamento || "", numeroEletrobomba: area.numeroEletrobomba || "", numeroCarreteis: carreteisStr, descricaoCompletaParada: "Sem registro de atividade", }); }
        else { paradasSnap.forEach(p => {
              const d = p.data(); let desc = "Opera√ß√£o Normal";
              if(d.tipoRegistro === 'parada') desc = `PARADA: ${d.codParada === 'C' ? `Carretel ${d.numeroCarretelParado}` : ''} ${d.descricaoParadaCodigo || ''} (${(Array.isArray(d.descricaoProblema) ? d.descricaoProblema.join('; ') : '')}${d.descricaoProblemaOutro ? `; Outro: ${d.descricaoProblemaOutro}` : ''})`;
              else if (d.tipoRegistro === 'complementar') desc = `IRRIGA√á√ÉO COMPLEMENTAR${d.numeroCarretelParado ? ` (substituindo ${d.numeroCarretelParado})` : ''}`;
              all.push({ projeto: area.projeto || "", bloco: area.bloco || "", bombeamento: area.bombeamento || "", numeroEletrobomba: area.numeroEletrobomba || "", numeroCarreteis: carreteisStr, velocidadeCarretel: area.velocidadeCarretel || "", metrosLinearesPlano: area.metrosLineares || "", vazao: area.vazao || "", tipoArea: area.tipoArea || "", tipoIrrigacao: area.tipoIrrigacao || "", tipoProduto: area.tipoProduto || "", horasPlanejadas: Number(area.horasPlanejadas||0).toFixed(2), numeroCroqui: area.numeroCroqui || "", proxBloco: area.proxBloco || "", descricaoCompletaParada: desc, inicioParada: formatDateTime(d.inicioParada), fimParada: formatDateTime(d.fimParada), duracaoHoras: d.duracaoHoras != null ? Number(d.duracaoHoras).toFixed(2) : "", registradoEm: d.createdAt?.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString("pt-BR") : "" }); });
        }
      }
      return all;
    }


    function toCSV(dados, useSemicolon = false) { if (!dados.length) return "Sem dados"; const sep = useSemicolon ? ";" : ","; const header = Object.keys(dados[0]).join(sep); const linhas = dados.map(row => Object.keys(dados[0]).map(c => `"${(row[c] ?? "").toString().replace(/"/g, '""')}"`).join(sep)); return header + "\n" + linhas.join("\n"); }
    function downloadBlob(blob, filename) { const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function gerarPDF(dados, ymd, titulo="Relat√≥rio") { if (!dados.length) { showMessage("Sem dados para exportar.", "error"); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: "landscape" }); doc.setFontSize(14); doc.text(`${titulo} - ${ymd}`, 14, 15); const colunas = Object.keys(dados[0]); const linhas = dados.map(d => colunas.map(c => d[c] || "")); doc.autoTable({ head: [colunas], body: linhas, startY: 20, styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [37, 99, 235] } }); doc.save(`${titulo.replaceAll(" ","_").toLowerCase()}_${ymd}.pdf`); }

    // ===== RELAT√ìRIOS CONSOLIDADOS =====
    $("#btnGerarRelatorio").addEventListener("click", gerarRelatoriosUI);
    $("#btnExportCSVRel").addEventListener("click", async () => { const { ymd, linhas } = await calcularRelatorio(); downloadBlob(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), toCSV(linhas, true)], { type: "text/csv;charset=utf-8;" }), `relatorio_${ymd}.csv`); });
    $("#btnExportPDFRel").addEventListener("click", async () => { const { ymd, linhas } = await calcularRelatorio(); gerarPDF(linhas, ymd, "Relat√≥rio Consolidado"); });

    async function calcularRelatorio() {
    // Obt√©m os filtros da interface do usu√°rio
    const ymd = filtroDataRel.value || todayYMD();
    const filtroProj = (filtroProjetoRel.value || "").trim();

    // --- IN√çCIO DA MODIFICA√á√ÉO DE SEGURAN√áA ---
    // Constr√≥i a consulta base para a cole√ß√£o de √Åreas
    let areasQuery = collection(db, COLLECTION);

    // 1. Aplica o filtro de seguran√ßa com base nos projetos do operador logado
    if (operadorLogado && !isAdmin && Array.isArray(operadorLogado.projetos) && operadorLogado.projetos.length > 0) {
        areasQuery = query(areasQuery, where("projeto", "in", operadorLogado.projetos));
    } else if (operadorLogado && !isAdmin) {
        // Se o operador n√£o tem projetos, bloqueia a consulta por seguran√ßa
        areasQuery = query(areasQuery, where("projeto", "==", "acesso_negado_sem_projeto_definido"));
    }

    // 2. Adiciona o filtro de projeto selecionado na tela (se houver)
    if (filtroProj) {
        areasQuery = query(areasQuery, where("projeto", "==", filtroProj));
    }

    // Executa a consulta j√° filtrada e segura no banco de dados
    const areasSnap = await getDocs(areasQuery);
    // --- FIM DA MODIFICA√á√ÉO DE SEGURAN√áA ---

    const areas = areasSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Inicializa as vari√°veis para os totais do relat√≥rio
    const linhas = [];
    let totalPlan = 0,
        totalParSistema = 0,
        totalMetrosPlano = 0,
        totalMetrosReal = 0,
        totalHectaresPlano = 0,
        totalHectaresReal = 0,
        totalMetrosHorimetro = 0,
        totalComplementar = 0,
        totalRodadasEficiencia = 0;

    // Itera sobre cada √°rea retornada pela consulta segura
    for (const area of areas) {
        // Busca os registros de atividade (paradas) para a √°rea no dia especificado
        const ref = collection(doc(db, COLLECTION, area.id), "paradas");
        const qy = query(ref, where("inicioParada", ">=", `${ymd}T00:00:00`), where("inicioParada", "<=", `${ymd}T23:59:59`));
        const snap = await getDocs(qy);

        let horasParadasSistema = 0,
            horasComplementar = 0,
            horasHorimetro = 0;
        const paradasPorCarretel = {};

        // Processa cada registro de atividade do dia
        snap.forEach(s => {
            const p = s.data();
            const duracao = Number(p.duracaoHoras) || 0;
            if (p.houveParada) {
                if (p.codParada === 'E' || p.codParada === 'R') { // Parada de Eletrobomba ou Rede afeta o sistema todo
                    horasParadasSistema += duracao;
                } else if (p.codParada === 'C' && p.numeroCarretelParado) { // Parada de Carretel √© individual
                    paradasPorCarretel[p.numeroCarretelParado] = (paradasPorCarretel[p.numeroCarretelParado] || 0) + duracao;
                }
            }
            if (p.tipoRegistro === 'complementar') {
                horasComplementar += duracao;
                if (p.numeroCarretelParado) { // Irriga√ß√£o complementar substitui um carretel
                    paradasPorCarretel[p.numeroCarretelParado] = (paradasPorCarretel[p.numeroCarretelParado] || 0) + duracao;
                }
            }
            if (p.horimetroFinal && p.horimetroInicial) { // Calcula horas rodadas via hor√≠metro
                horasHorimetro += (Number(String(p.horimetroFinal).replace(',', '.')) - Number(String(p.horimetroInicial).replace(',', '.')));
            }
        });

        // Obt√©m os par√¢metros da √°rea para os c√°lculos
        const planejadas = Number(area.horasPlanejadas || 0);
        const velocidade = Number(area.velocidadeCarretel || 0);
        const qtdCarreteis = Number(area.quantidadeCarreteis || 1);
        const carreteis = Array.isArray(area.carreteis) ? area.carreteis : [];

        let metrosRealArea = 0,
            totalHorasRodadasReais = 0;
        
        // Calcula as horas e metros reais para cada carretel individualmente
        for (const numCarretel of carreteis) {
            const paradasDoCarretel = paradasPorCarretel[numCarretel] || 0;
            const horasRodadasCarretel = Math.max(0, planejadas - horasParadasSistema - paradasDoCarretel);
            totalHorasRodadasReais += horasRodadasCarretel;
            metrosRealArea += horasRodadasCarretel * velocidade;
        }

        // Calcula a efici√™ncia (considera apenas paradas de sistema, n√£o de carreteis individuais)
        const horasRodadasParaEficiencia = Math.max(0, planejadas - horasParadasSistema);
        const efic = planejadas > 0 ? (horasRodadasParaEficiencia / planejadas) * 100 : 0;

        // Calcula os totais de metros e hectares (plano vs. real)
        const metrosPlano = planejadas * velocidade * qtdCarreteis;
        const hectaresPlano = metrosPlano * fatorCarreador;
        const hectaresReal = metrosRealArea * fatorCarreador;
        const metrosRealHorimetro = horasHorimetro * velocidade * qtdCarreteis;

        // Acumula os totais para o sum√°rio do relat√≥rio
        totalPlan += planejadas;
        totalParSistema += horasParadasSistema;
        totalComplementar += horasComplementar;
        totalMetrosPlano += metrosPlano;
        totalMetrosReal += metrosRealArea;
        totalHectaresPlano += hectaresPlano;
        totalHectaresReal += hectaresReal;
        totalMetrosHorimetro += metrosRealHorimetro;
        totalRodadasEficiencia += horasRodadasParaEficiencia;

        // Adiciona a linha processada ao array de linhas da tabela
        linhas.push({
            numeroCroqui: area.numeroCroqui || "",
            projeto: area.projeto || "",
            bloco: area.bloco || "",
            bombeamento: area.bombeamento || "",
            eletrobomba: area.numeroEletrobomba || "",
            carretel: carreteis.join(', '),
            horasPlanejadas: planejadas.toFixed(2),
            horasParadas: horasParadasSistema.toFixed(2),
            horasComplementar: horasComplementar.toFixed(2),
            horasRodadas: horasRodadasParaEficiencia.toFixed(2),
            eficiencia: `${efic.toFixed(1)}%`,
            metrosLinearesPlano: metrosPlano.toFixed(2),
            metrosLinearesReal: metrosRealArea.toFixed(2),
            hectaresPlano: hectaresPlano.toFixed(2),
            hectaresReal: hectaresReal.toFixed(2)
        });
    }

    // Retorna os dados processados: o sum√°rio e as linhas da tabela
    return {
        ymd,
        sum: {
            totalPlan,
            totalPar: totalParSistema,
            rodadasTot: totalRodadasEficiencia,
            eficTot: totalPlan > 0 ? (totalRodadasEficiencia / totalPlan) * 100 : 0,
            totalMetrosPlano,
            totalMetrosReal,
            totalHectaresPlano,
            totalHectaresReal,
            totalMetrosHorimetro,
            totalComplementar
        },
        linhas
    };
}

    async function gerarRelatoriosUI(){
      const sumPlane = $("#sumPlanejadas"), sumPar = $("#sumParadas"), sumRod = $("#sumRodadas"), sumEf = $("#sumEficiencia"), sumMetrosPlanoEl = $("#sumMetrosPlano"), sumMetrosRealEl = $("#sumMetrosReal"), sumHectaresPlanoEl = $("#sumHectaresPlano"), sumHectaresRealEl = $("#sumHectaresReal"), sumMetrosHorimetroEl = $("#sumMetrosHorimetro"), sumComplementarEl = $("#sumComplementar"), tabelaRel = $("#tabelaRel");
      tabelaRel.innerHTML = `<div class="text-sm text-gray-600">Calculando...</div>`;
      const { sum, linhas } = await calcularRelatorio();
      sumPlane.textContent = sum.totalPlan.toFixed(2); sumPar.textContent = sum.totalPar.toFixed(2); sumRod.textContent = sum.rodadasTot.toFixed(2); sumEf.textContent = `${sum.eficTot.toFixed(1)}%`; sumMetrosPlanoEl.textContent = sum.totalMetrosPlano.toFixed(2); sumMetrosRealEl.textContent = sum.totalMetrosReal.toFixed(2); sumHectaresPlanoEl.textContent = sum.totalHectaresPlano.toFixed(2); sumHectaresRealEl.textContent = sum.totalHectaresReal.toFixed(2); sumMetrosHorimetroEl.textContent = sum.totalMetrosHorimetro.toFixed(2); sumComplementarEl.textContent = sum.totalComplementar.toFixed(2);
      if (!linhas.length){ tabelaRel.innerHTML = `<div class="text-sm text-gray-600">Sem dados para os filtros.</div>`; return; }
      const headers = ["Croqui", "Projeto","Bloco","Bomb.","Eletro.","Carretel(√©is)","H. Plan","H. Par","H. Compl.", "H. Rod","Efic.", "ML Plan", "ML Real", "HA Plan", "HA Real"];
      const thead = `<thead><tr>${headers.map(h=>`<th class="px-3 py-2 border-b bg-gray-50 text-left text-sm font-semibold">${h}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${linhas.map(l=>`<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-sm">${l.numeroCroqui}</td><td class="px-3 py-2 text-sm">${l.projeto}</td><td class="px-3 py-2 text-sm">${l.bloco}</td><td class="px-3 py-2 text-sm">${l.bombeamento}</td><td class="px-3 py-2 text-sm">${l.eletrobomba}</td><td class="px-3 py-2 text-sm">${l.carretel}</td><td class="px-3 py-2 text-sm">${l.horasPlanejadas}</td><td class="px-3 py-2 text-sm text-amber-800">${l.horasParadas}</td><td class="px-3 py-2 text-sm text-sky-800">${l.horasComplementar}</td><td class="px-3 py-2 text-sm text-emerald-800">${l.horasRodadas}</td><td class="px-3 py-2 text-sm font-semibold">${l.eficiencia}</td><td class="px-3 py-2 text-sm">${l.metrosLinearesPlano}</td><td class="px-3 py-2 text-sm font-semibold text-teal-800">${l.metrosLinearesReal}</td><td class="px-3 py-2 text-sm font-semibold text-green-800">${l.hectaresPlano}</td><td class="px-3 py-2 text-sm font-semibold text-green-800">${l.hectaresReal}</td></tr>`).join("")}</tbody>`;
      tabelaRel.innerHTML = `<div class="overflow-auto"><table class="min-w-full">${thead}${tbody}</table></div>`;
    }
    
    // ===== RELAT√ìRIO INDIVIDUAL =====
    async function popularFiltroAreaIndividual(areas) {
        const select = $("#filtroAreaIndividual"); select.innerHTML = `<option value="">-- Selecione uma √Årea --</option>`;
        const areasAtivas = areas.filter(a => a.finalizada !== true && (!operadorLogado || isAdmin || (operadorLogado.projetos && operadorLogado.projetos.includes(a.projeto))));
        areasAtivas.sort((a, b) => (a.bloco || '').localeCompare(b.bloco || ''));
        areasAtivas.forEach(area => { const option = document.createElement('option'); option.value = area.id; option.textContent = `${area.bloco} (${area.projeto})`; select.appendChild(option); });
    }

    $("#btnGerarRelatorioIndividual").addEventListener("click", gerarRelatorioIndividualUI);

    async function gerarRelatorioIndividualUI() {
        const areaId = $("#filtroAreaIndividual").value, ymd = $("#filtroDataRel").value || todayYMD();
        const tabelaInd = $("#tabelaRelIndividual");
        if (!areaId) { showMessage("Selecione uma √°rea.", "error"); tabelaInd.innerHTML = ''; return; }
        tabelaInd.innerHTML = `<div class="text-sm text-gray-600">Calculando...</div>`;
        const areaDoc = await getDoc(doc(db, COLLECTION, areaId));
        if (!areaDoc.exists()) { showMessage("√Årea n√£o encontrada.", "error"); tabelaInd.innerHTML = ''; return; }
        const area = areaDoc.data();
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const qy = query(ref, where("inicioParada", ">=", `${ymd}T00:00:00`), where("inicioParada", "<=", `${ymd}T23:59:59`), orderBy("inicioParada", "asc"));
        const snap = await getDocs(qy);
        let horasParadasSistema = 0, horasHorimetro = 0, horasComplementar = 0; const paradasPorCarretel = {}, paradasTabela = [];
        snap.forEach(s => {
            const p = s.data(), duracao = Number(p.duracaoHoras) || 0, tipo = p.tipoRegistro || (p.houveParada ? 'parada' : 'sem_parada');
            if (p.houveParada) { if (p.codParada === 'E' || p.codParada === 'R') horasParadasSistema += duracao; else if (p.codParada === 'C' && p.numeroCarretelParado) paradasPorCarretel[p.numeroCarretelParado] = (paradasPorCarretel[p.numeroCarretelParado] || 0) + duracao; }
            if (tipo === 'complementar') { horasComplementar += duracao; if (p.numeroCarretelParado) paradasPorCarretel[p.numeroCarretelParado] = (paradasPorCarretel[p.numeroCarretelParado] || 0) + duracao; }
            if (p.horimetroFinal && p.horimetroInicial) horasHorimetro += (Number(String(p.horimetroFinal).replace(',','.')) - Number(String(p.horimetroInicial).replace(',','.')));
            let tipoLabel = "Op. Normal", problema = '-';
            if (tipo === 'parada') { tipoLabel = `Parada (${p.codParada === 'C' ? 'Carretel' : 'Sistema'})`; problema = (Array.isArray(p.descricaoProblema) ? p.descricaoProblema.join(', ') : '') + (p.descricaoProblemaOutro ? ` (Outro: ${p.descricaoProblemaOutro})` : ''); }
            if (tipo === 'complementar') { tipoLabel = "Irrig. Compl."; if(p.numeroCarretelParado) problema = `Substituindo ${p.numeroCarretelParado}`; }
            paradasTabela.push({ tipoRegistro: tipoLabel, problema: problema, carretel: p.numeroCarretelParado || '-', inicio: formatDateTime(p.inicioParada), fim: formatDateTime(p.fimParada), duracao: duracao.toFixed(2), horimetroInicial: p.horimetroInicial || "-", horimetroFinal: p.horimetroFinal || "-", descricaoCompleta: p.descricaoParadaCodigo || "-" });
        });
        const planejadas = Number(area.horasPlanejadas || 0), velocidade = Number(area.velocidadeCarretel || 0), qtdCarreteis = Number(area.quantidadeCarreteis || 1), carreteis = Array.isArray(area.carreteis) ? area.carreteis : [];
        let metrosRealArea = 0, totalHorasRodadasReais = 0;
        for(const numCarretel of carreteis) {
            const paradasDoCarretel = paradasPorCarretel[numCarretel] || 0;
            const horasRodadasCarretel = Math.max(0, planejadas - horasParadasSistema - paradasDoCarretel);
            totalHorasRodadasReais += horasRodadasCarretel; metrosRealArea += horasRodadasCarretel * velocidade;
        }
        const rodadas = Math.max(0, planejadas - horasParadasSistema), efic = planejadas > 0 ? (rodadas / planejadas) * 100 : 0;
        const metrosPlano = planejadas * velocidade * qtdCarreteis, hectaresPlano = metrosPlano * fatorCarreador, hectaresReal = metrosRealArea * fatorCarreador, metrosRealHorimetro = horasHorimetro * velocidade * qtdCarreteis;
        $("#sumPlanejadasInd").textContent = planejadas.toFixed(2); $("#sumParadasInd").textContent = horasParadasSistema.toFixed(2); $("#sumRodadasInd").textContent = rodadas.toFixed(2); $("#sumEficienciaInd").textContent = `${efic.toFixed(1)}%`; $("#sumMetrosPlanoInd").textContent = metrosPlano.toFixed(2); $("#sumMetrosRealInd").textContent = metrosRealArea.toFixed(2); $("#sumHectaresPlanoInd").textContent = hectaresPlano.toFixed(2); $("#sumHectaresRealInd").textContent = hectaresReal.toFixed(2); $("#sumMetrosHorimetroInd").textContent = metrosRealHorimetro.toFixed(2); $("#sumComplementarInd").textContent = horasComplementar.toFixed(2);
        if (!paradasTabela.length) { tabelaInd.innerHTML = `<div class="text-sm text-gray-600">Nenhum registro de atividade para o dia.</div>`; return; }
        const headers = ["Tipo", "Carretel", "Problema", "In√≠cio", "Fim", "Dura√ß√£o (h)", "Hor. Inicial", "Hor. Final", "C√≥d. Parada"];
        const thead = `<thead><tr>${headers.map(h => `<th class="px-3 py-2 border-b bg-gray-50 text-left text-sm font-semibold">${h}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${paradasTabela.map(p => `<tr class="hover:bg-gray-50"><td class="px-3 py-2 text-sm">${p.tipoRegistro}</td><td class="px-3 py-2 text-sm">${p.carretel}</td><td class="px-3 py-2 text-sm">${p.problema}</td><td class="px-3 py-2 text-sm">${p.inicio}</td><td class="px-3 py-2 text-sm">${p.fim}</td><td class="px-3 py-2 text-sm">${p.duracao}</td><td class="px-3 py-2 text-sm">${p.horimetroInicial}</td><td class="px-3 py-2 text-sm">${p.horimetroFinal}</td><td class="px-3 py-2 text-sm">${p.descricaoCompleta}</td></tr>`).join("")}</tbody>`;
        tabelaInd.innerHTML = `<div class="overflow-auto"><table class="min-w-full">${thead}${tbody}</table></div>`;
    }
    
    // ===== L√ìGICA DE ADMIN =====
    function verificarSenhaAdmin() {
        if (isAdmin) {
            isAdmin = false;
            showMessage("Acesso de administrador encerrado.", "sync");
            if (operadorLogado) listarAreasOperador(); // Recarrega a view com permiss√µes normais
            return;
        }
        const senha = prompt("Digite a senha de administrador:");
        if (senha === SENHA_SECRETA_ADMIN) {
            isAdmin = true;
            liberarTodasAbas();
            showMessage("Acesso de administrador liberado!", "success");
            if (operadorLogado) listarAreasOperador(); // Recarrega a view com permiss√µes de admin
        } else if (senha) {
            showMessage("Senha incorreta.", "error");
        }
    }
    
    function liberarTodasAbas() {
        $$('.aba-bloqueada').forEach(aba => aba.classList.remove('aba-bloqueada'));
        const activeTab = $('.tab-btn.active')?.dataset.tab || 'operador';
        atualizarMenuMobile(activeTab);
    }

    // ===== L√ìGICA DE LOGIN E SESS√ÉO =====
    async function handleLoginOperador(e) {
      e.preventDefault();
      const matricula = $("#loginMatricula").value.trim();
      const nome = $("#loginNome").value.trim();
      if (!matricula || !nome) { loginError.textContent = "Preencha todos os campos."; loginError.classList.remove("hidden"); return; }
      try {
        const q = query(collection(db, "operadores"), where("matricula", "==", matricula));
        const snap = await getDocs(q);
        if (snap.empty) { loginError.textContent = "Matr√≠cula n√£o encontrada."; loginError.classList.remove("hidden"); return; }
        const opDoc = snap.docs[0], opData = opDoc.data();
        if (opData.nome.toLowerCase() === nome.toLowerCase()) {
          operadorLogado = { id: opDoc.id, ...opData };
          sessionStorage.setItem('operadorLogado', JSON.stringify(operadorLogado));
          iniciarSessao();
        } else {
          loginError.textContent = "Nome n√£o corresponde √† matr√≠cula.";
          loginError.classList.remove("hidden");
        }
      } catch (err) { console.error("Erro no login:", err); loginError.textContent = "Erro ao tentar fazer login."; loginError.classList.remove("hidden"); }
    }

    function iniciarSessao() {
        loginScreen.classList.add("hidden"); mainContent.classList.remove("hidden");
        // Libera apenas as abas de operador e relat√≥rios por padr√£o para o operador
        $$('.tab-btn[data-tab="operador"], .tab-btn[data-tab="relatorios"]').forEach(aba => aba.classList.remove('aba-bloqueada'));
        const activeTab = $('.tab-btn.active')?.dataset.tab || 'operador';
        atualizarMenuMobile(activeTab);

        const welcome = document.createElement('div');
        welcome.id = 'welcomeMessage'; welcome.className = 'text-sm text-gray-700';
        welcome.textContent = `Sess√£o: ${operadorLogado.nome} (${operadorLogado.matricula})`;
        header.insertAdjacentElement('afterend', welcome);
        observarAreas();
    }

    function handleLogout() {
      if (confirm("Deseja encerrar a sess√£o?")) {
        operadorLogado = null; isAdmin = false;
        sessionStorage.removeItem('operadorLogado');
        mainContent.classList.add("hidden"); loginScreen.classList.remove("hidden");
        $("#formLoginOperador").reset(); loginError.classList.add("hidden");
        const welcome = $("#welcomeMessage"); if (welcome) welcome.remove();
        // Bloqueia as abas novamente
        $$('.tab-btn').forEach(aba => { if(aba.dataset.tab !== 'operador') aba.classList.add('aba-bloqueada'); });
        switchTab('operador');
      }
    }

    function verificarSessao() {
      const sessaoSalva = sessionStorage.getItem('operadorLogado');
      if (sessaoSalva) {
        operadorLogado = JSON.parse(sessaoSalva);
        iniciarSessao();
      }
    }

    // ===== INICIALIZA√á√ÉO =====
    (function popularSelectsEstaticos() {
        const selCodigos = $("#descricaoParadaCodigoSelect");
        selCodigos.innerHTML = `<option value="">Selecione um c√≥digo</option>`;
        codigosParada.forEach(c => { selCodigos.innerHTML += `<option value="${c}">${c}</option>`; });
        const contProblemas = $("#listaProblemas");
        problemasOpcoes.forEach(p => { const label = document.createElement('label'); label.className = 'flex items-center p-1 hover:bg-gray-100 rounded cursor-pointer'; label.innerHTML = `<input type="checkbox" name="problema" value="${p}" class="form-checkbox h-4 w-4 text-blue-600"><span class="ml-2 text-sm text-gray-700">${p}</span>`; contProblemas.appendChild(label); });
    })();
    
    document.addEventListener('DOMContentLoaded', () => {
      updateConnUI();
      $("#formLoginOperador").addEventListener("submit", handleLoginOperador);
      $("#btnAdminLogin").addEventListener("click", verificarSenhaAdmin);
      $("#btnSessao").addEventListener("click", handleLogout);
      switchTab('operador');
      verificarSessao();
    });
  </script>
</body>
</html>

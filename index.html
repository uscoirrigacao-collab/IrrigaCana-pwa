<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>InfoCana ‚Ä¢ USCO </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb"/>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"> </script>
  <style>.tab-btn.active {border-color: #2563eb; /* Azul principal */color: #2563eb;font-weight: 600;}.tab-btn {
   transition: all 0.2s ease-in-out;}.aba-bloqueada {opacity: 0.5;pointer-events: none;cursor: not-allowed;}#menuAbas {opacity: 0;transform: scaleY(0.95);transform-origin: top right;}#menuAbas.show {opacity: 1;transform: scaleY(1);}.menu-icon .bar {
  left: 0;
}

.menu-icon.open .bar:nth-child(1) {
  transform: rotate(45deg);
  top: 12px;
}

.menu-icon.open .bar:nth-child(2) {
  opacity: 0;
}

.menu-icon.open .bar:nth-child(3) {
  transform: rotate(-45deg);
  top: 12px;
}





</style>

</head>


<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8 px-4 font-sans text-gray-800">

  <main class="w-full max-w-6xl">
    <header class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
      <h1 class="text-2xl font-bold text-orange-600">InfoCana ‚Ä¢ USCO</h1>
      <button id="btnDesbloquear" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Admin</button>
    </header>

    <div id="mensagem" class="hidden p-3 rounded mb-4"></div>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <span id="dotConexao" class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
        <span id="txtConexao" class="text-sm text-gray-700">Conectado</span>
      </div>
      <div class="text-xs text-gray-500">
        As altera√ß√µes feitas <strong>offline</strong> ser√£o sincronizadas automaticamente ao restabelecer a conex√£o.
      </div>
    </div>
    

<div id="navContainer" class="border-b border-gray-200 mb-6 flex items-center justify-between">
  <nav class="-mb-px hidden md:flex space-x-6" aria-label="Tabs">
    <button data-tab="projetos"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìÇ Projetos
    </button>

    <button data-tab="cadastro"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìù Cadastro de √Åreas
    </button>

    <button data-tab="operador"
      class="tab-btn flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-blue-600 border-blue-600 active">
      ‚úÖ √Åreas Cadastradas
    </button>

    <button data-tab="relatorios"
      class="tab-btn aba-bloqueada flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
      üìä Relat√≥rios
    </button>
  </nav>

  <div class="relative md:hidden ml-auto">
    <button id="menuAbasBtn" class="flex items-center gap-2 py-3 px-4 text-gray-700 hover:text-blue-600 font-medium">
      <span id="menuAbasLabel"></span> <div class="menu-icon w-6 h-6 relative">
        <span class="bar absolute top-1 w-6 h-0.5 bg-current transition-all duration-300"></span>
        <span class="bar absolute top-3 w-6 h-0.5 bg-current transition-all duration-300"></span>
        <span class="bar absolute top-5 w-6 h-0.5 bg-current transition-all duration-300"></span>
      </div>
    </button>

    <div id="menuAbas" class="hidden absolute right-0 mt-2 w-56 bg-white border rounded shadow-lg z-20">
      </div>
  </div>
</div>

      <section id="content-projetos" class="p-6 hidden space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-orange-600">Projetos</h1>
        <p class="text-sm text-gray-600">Gerencie os projetos, insira ou remova.</p>

        <form id="formProjeto" class="flex gap-2 items-end">
          <div class="flex-1">
            <label for="novoProjeto" class="block text-sm font-semibold mb-1">Novo Projeto</label>
            <input id="novoProjeto" class="w-full border rounded px-3 py-2" placeholder="Ex: Projeto A" />
          </div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Adicionar</button>
        </form>

        <div>
          <h3 class="font-semibold mb-2">Lista de Projetos</h3>
          <ul id="listaProjetos" class="space-y-2"></ul>
        </div>
      </section>

      <section id="content-cadastro" class="p-6 hidden space-y-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-orange-600">Cadastro de √Åreas</h1>

        <form id="formArea" class="space-y-6" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label for="projeto" class="block text-sm font-semibold mb-1">Projeto</label>
              <select id="projeto" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div>
              <label for="bombeamento" class="block text-sm font-semibold mb-1">Bombeamento</label>
              <input id="bombeamento" required class="w-full border rounded px-3 py-2" placeholder="Ex: B01" />
            </div>
            <div>
              <label for="bloco" class="block text-sm font-semibold mb-1">Nome do Bloco</label>
              <input id="bloco" required class="w-full border rounded px-3 py-2" placeholder="Ex: 21 - Vila EB1" />
            </div>
            
            <div>
              <label for="numeroEletrobomba" class="block text-sm font-semibold mb-1">N¬∞ Eletrobomba</label>
              <input id="numeroEletrobomba" required class="w-full border rounded px-3 py-2" placeholder="Ex: 130001" />
            </div>
            <div>
              <label for="numeroCarretel" class="block text-sm font-semibold mb-1">N¬∞ Carretel</label>
              <input id="numeroCarretel" required class="w-full border rounded px-3 py-2" placeholder="Ex: 138001" />
            </div>
            <div>
              <label for="tipoArea" class="block text-sm font-semibold mb-1">Tipo de √Årea</label>
              <select id="tipoArea" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
              <option value="">-- Selecione --</option>
              <option value="Moagem">Moagem</option>
              <option value="Pr√©-plantio">Pr√©-plantio</option>
              <option value="Plantio">Plantio</option>
              <option value="Socaria">Socaria</option>
              </select>
            </div>
            <div>
              <label for="tipoIrrigacao" class="block text-sm font-semibold mb-1">Tipo de Irriga√ß√£o</label>
               <select id="tipoIrrigacao" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
              <option value="">-- Selecione --</option>
              <option value="Carretel">Carretel</option>
              <option value="Pivo">Pivo</option>
              <option value="Convencional">Convencional</option>
              <option value="Pressurizada">Pressurizada</option>
              </select>
             </div>
             <div>
               <label for="tipoProduto" class="block text-sm font-semibold mb-1">Produto</label>
               <select id="tipoProduto" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
               <option value="">-- Selecione --</option>
               <option value="√Ågua">√Ågua</option>
               <option value="Vinha√ßa">Vinha√ßa</option>
               </select>
            </div>
            <div>
              <label for="horasPlanejadas" class="block text-sm font-semibold mb-1">Horas Planejadas (dia)</label>
              <input id="horasPlanejadas" type="number" min="0" max="24" step="0.25" required class="w-full border rounded px-3 py-2" placeholder="Ex: 24" />
            </div>
            <div>
              <label for="velocidadeCarretel" class="block text-sm font-semibold mb-1">Velocidade do Carretel (m/h)</label>
              <input id="velocidadeCarretel" type="number" min="0" step="0.1" required class="w-full border rounded px-3 py-2" placeholder="Ex: 15.5" />
            </div>
            <div>
              <label for="metrosLineares" class="block text-sm font-semibold mb-1">Metros Lineares (m)</label>
              <input id="metrosLineares" readonly class="w-full border rounded px-3 py-2 bg-gray-200" placeholder="Calculado" />
            </div>
            <div>
              <label for="numeroCroqui" class="block text-sm font-semibold mb-1">N¬∞ Croqui</label>
              <input id="numeroCroqui" required class="w-full border rounded px-3 py-2" placeholder="Ex: 0001" />
            </div>
            <div>
              <label for="proxBloco" class="block text-sm font-semibold mb-1">Pr√≥x. Bloco a Irrigar</label>
              <input id="proxBloco" class="w-full border rounded px-3 py-2" placeholder="Ex: 22 - Vila EB2" />
            </div>
            <div>
              <label for="vazao" class="block text-sm font-semibold mb-1">Vaz√£o m¬≥/h</label>
              <input id="vazao" required class="w-full border rounded px-3 py-2" placeholder="Ex: 120 m¬≥/h" />
            </div>

          </div>

          <div class="flex justify-end gap-3">
            <button type="submit" id="salvarArea" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar √Årea</button>
            <button type="button" id="cancelarEdicao" class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
          </div>
        </form>

        <hr class="border-gray-200" />

        <div>
          <label for="filtroProjetoCadastro" class="block mb-2 font-semibold text-gray-700">Filtrar √Åreas por Projeto</label>
          <select id="filtroProjetoCadastro" class="w-full max-w-sm border rounded px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
            <option value="">-- Todos os Projetos --</option>
          </select>
        </div>

        <div id="listaAreasCadastro" class="space-y-3"></div>
      </section>

      <section id="content-operador" class="p-6 hidden space-y-6">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <h2 class="text-2xl md:text-3xl font-semibold text-orange-600">Operador</h2>
          </div>
          <div class="flex gap-2">

            <button id="btnExportCSV" class="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 text-sm">Exportar CSV (dia)</button>
            <button id="btnExportPDF" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm">Exportar PDF (dia)</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroProjetoOperador">Projeto</label>
            <select id="filtroProjetoOperador" class="w-full border rounded px-3 py-2">
              <option value="">-- Todos os Projetos --</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="filtroDataOperador">Data</label>
            <input type="date" id="filtroDataOperador" class="w-full border rounded px-3 py-2" />
          </div>
          <div class="flex items-end">
            <button id="btnFiltrarOperador" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Aplicar Filtros</button>
          </div>
        </div>

        <div id="listaAreasOperador" class="space-y-3"></div>
      </section>

      <section id="content-relatorios" class="p-6 hidden space-y-6">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <h2 class="text-2xl md:text-3xl font-semibold text-orange-600">Relat√≥rios</h2>
            <p class="text-sm text-gray-600">Consolida√ß√£o di√°ria por projeto e por √°rea.</p>
          </div>
          <div class="flex gap-2">
            <button id="btnExportCSVRel" class="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 text-sm">Exportar CSV (Relat√≥rio)</button>
            <button id="btnExportPDFRel" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm">Exportar PDF (Relat√≥rio)</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroProjetoRel">Projeto</label>
            <select id="filtroProjetoRel" class="w-full border rounded px-3 py-2">
              <option value="">-- Todos os Projetos --</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="filtroDataRel">Data</label>
            <input type="date" id="filtroDataRel" class="w-full border rounded px-3 py-2" />
          </div>
          <div class="flex items-end">
            <button id="btnGerarRelatorio" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gerar</button>
          </div>
        </div>

        <div id="sumarioRel" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-2">
          <div class="flex items-center space-x-3 bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <div class="text-xs font-semibold text-blue-700 uppercase">Horas Planejadas</div>
              <div id="sumPlanejadas" class="text-2xl font-bold text-blue-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-amber-50 border border-amber-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
            <div>
              <div class="text-xs font-semibold text-amber-700 uppercase">Horas Paradas</div>
              <div id="sumParadas" class="text-2xl font-bold text-amber-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-emerald-50 border border-emerald-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.944 12c.032 4.418 2.378 8.42 6.114 10.153a1 1 0 001.077-.042A12.01 12.01 0 0012 21.056c4.418-.032 8.42-2.378 10.153-6.114a1 1 0 00-.042-1.077c-1.734-2.221-4.075-3.951-6.114-5.642z" /></svg>
            <div>
              <div class="text-xs font-semibold text-emerald-700 uppercase">Horas Rodadas</div>
              <div id="sumRodadas" class="text-2xl font-bold text-emerald-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-purple-50 border border-purple-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M4 8h16M4 16h16" /></svg>
            <div>
              <div class="text-xs font-semibold text-purple-700 uppercase">Efici√™ncia</div>
              <div id="sumEficiencia" class="text-2xl font-bold text-purple-900">0%</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-teal-50 border border-teal-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7.5l-2.165 2.165a1.583 1.583 0 00-2.243 0L10 17.25m6-4.5L10 17.25M7.5 4.5l-3 3m10.5 6L8.25 10.5M5.25 15.75l-1.5 1.5M10.5 4.5l-3 3" /></svg>
            <div>
              <div class="text-xs font-semibold text-teal-700 uppercase">Metros Lineares (m)</div>
              <div class="text-xl font-bold text-teal-900">
                  Plano: <span id="sumMetrosPlano">0</span>
              </div>
              <div class="text-xl font-bold text-teal-900">
                  Real: <span id="sumMetrosReal">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-green-700 uppercase">Hectares Irrigados (ha)</div>
              <div class="text-xl font-bold text-green-900">
                  Plano: <span id="sumHectaresPlano">0</span>
              </div>
              <div class="text-xl font-bold text-green-900">
                  Real: <span id="sumHectaresReal">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-cyan-50 border border-cyan-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-cyan-700 uppercase">Metros Lineares (Hor√≠metro)</div>
              <div id="sumMetrosHorimetro" class="text-2xl font-bold text-cyan-900">0</div>
            </div>
          </div>
        </div>

        <div id="tabelaRel" class="space-y-3 mt-4"></div>

        <hr class="border-gray-200 my-8" />

        <h3 class="text-xl md:text-2xl font-semibold text-blue-900">Relat√≥rio por √Årea</h3>
        <p class="text-sm text-gray-600">Gere um relat√≥rio detalhado para uma √°rea espec√≠fica.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 font-semibold" for="filtroAreaIndividual">Selecionar √Årea</label>
            <select id="filtroAreaIndividual" class="w-full border rounded px-3 py-2">
              <option value="">-- Selecione uma √Årea --</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnGerarRelatorioIndividual" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gerar Relat√≥rio Individual</button>
          </div>
        </div>

        <div id="sumarioRelIndividual" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-2">
          <div class="flex items-center space-x-3 bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <div class="text-xs font-semibold text-blue-700 uppercase">Horas Planejadas</div>
              <div id="sumPlanejadasInd" class="text-2xl font-bold text-blue-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-amber-50 border border-amber-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
            <div>
              <div class="text-xs font-semibold text-amber-700 uppercase">Horas Paradas</div>
              <div id="sumParadasInd" class="text-2xl font-bold text-amber-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-emerald-50 border border-emerald-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.944 12c.032 4.418 2.378 8.42 6.114 10.153a1 1 0 001.077-.042A12.01 12.01 0 0012 21.056c4.418-.032 8.42-2.378 10.153-6.114a1 1 0 00-.042-1.077c-1.734-2.221-4.075-3.951-6.114-5.642z" /></svg>
            <div>
              <div class="text-xs font-semibold text-emerald-700 uppercase">Horas Rodadas</div>
              <div id="sumRodadasInd" class="text-2xl font-bold text-emerald-900">0</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-purple-50 border border-purple-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M4 8h16M4 16h16" /></svg>
            <div>
              <div class="text-xs font-semibold text-purple-700 uppercase">Efici√™ncia</div>
              <div id="sumEficienciaInd" class="text-2xl font-bold text-purple-900">0%</div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-teal-50 border border-teal-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7.5l-2.165 2.165a1.583 1.583 0 00-2.243 0L10 17.25m6-4.5L10 17.25M7.5 4.5l-3 3m10.5 6L8.25 10.5M5.25 15.75l-1.5 1.5M10.5 4.5l-3 3" /></svg>
            <div>
              <div class="text-xs font-semibold text-teal-700 uppercase">Metros Lineares (m)</div>
              <div class="text-xl font-bold text-teal-900">
                  Plano: <span id="sumMetrosPlanoInd">0</span>
              </div>
              <div class="text-xl font-bold text-teal-900">
                  Real: <span id="sumMetrosRealInd">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-green-700 uppercase">Hectares Irrigados (ha)</div>
              <div class="text-xl font-bold text-green-900">
                  Plano: <span id="sumHectaresPlanoInd">0</span>
              </div>
              <div class="text-xl font-bold text-green-900">
                  Real: <span id="sumHectaresRealInd">0</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 bg-cyan-50 border border-cyan-200 p-4 rounded-lg shadow-sm">
            <svg class="w-8 h-8 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <div>
              <div class="text-xs font-semibold text-cyan-700 uppercase">Metros Lineares (Hor√≠metro)</div>
              <div id="sumMetrosHorimetroInd" class="text-2xl font-bold text-cyan-900">0</div>
            </div>
          </div>
        </div>
        <div id="tabelaRelIndividual" class="space-y-3 mt-4"></div>
      </section>
    </div>
  </main>



  <div id="modalParada" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white w-full max-w-xl rounded-lg shadow-lg p-6 relative max-h-[90vh] overflow-y-auto">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      <h3 id="modalTitle" class="text-xl font-semibold mb-4">Registrar Parada</h3>

      <div id="modalInfoArea" class="text-sm text-gray-700 mb-4"></div>

      <form id="formParada" class="space-y-4" novalidate>
        <fieldset class="border rounded p-3">
          <legend class="font-semibold text-gray-800">Houve parada?</legend>
          <label class="inline-flex items-center mr-6 cursor-pointer">
            <input type="radio" name="houveParadaModal" value="sim" class="form-radio text-blue-600" required />
            <span class="ml-2">Sim</span>
          </label>
          <label class="inline-flex items-center cursor-pointer">
            <input type="radio" name="houveParadaModal" value="nao" class="form-radio text-blue-600" />
            <span class="ml-2">N√£o</span>
          </label>
        </fieldset>

        <div id="camposParada" class="hidden space-y-3">
          <div>
            <label class="block text-sm font-semibold">Tipo de equipamento</label>
            <select id="codParada" class="w-full border rounded px-3 py-2" required>
              <option value="">Selecione</option>
              <option value="E">Eletrobomba (E)</option>
              <option value="C">Carretel (C)</option>
              <option value="R">Rede (R)</option>
            </select>
          </div>
          
          <div>
            <label for="horimetroInicial" class="block text-sm font-medium text-gray-700">Hor√≠metro Inicial</label>
            <input type="text" id="horimetroInicial" name="horimetroInicial" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ex: 1234.5">
          </div>
          <div>
            <label for="horimetroFinal" class="block text-sm font-medium text-gray-700">Hor√≠metro Final</label>
            <input type="text" id="horimetroFinal" name="horimetroFinal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ex: 1235.0">
          </div>

          <div>
            <label class="block text-sm font-semibold">Equipamento/Rede com problema</label>
            <input id="equipamentoProblemaModal" type="text" class="w-full border rounded px-3 py-2" placeholder="Ex: 130001 ou Rede St.Antonio" />
          </div>

          <div>
            <label class="block text-sm font-semibold">Descri√ß√£o da Parada (c√≥digo)</label>
            <select id="descricaoParadaCodigoSelect" class="w-full border rounded px-3 py-2" required></select>
          </div>

          <div>
            <label class="block text-sm font-semibold">Descri√ß√£o do Problema (selecione um ou mais)</label>
            <div id="listaProblemas" class="max-h-48 overflow-y-auto border rounded p-2 space-y-1 mt-1">
              </div>
            <div class="mt-2">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="problemaOutro" class="form-checkbox">
                    <span class="ml-2">Outro</span>
                </label>
                <textarea id="descricaoProblemaOutro" class="hidden w-full border rounded px-3 py-2 mt-1" rows="2" placeholder="Descreva o outro problema"></textarea>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold">In√≠cio</label>
              <input id="inicioParada" type="datetime-local" class="w-full border rounded px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-semibold">T√©rmino</label>
              <input id="fimParada" type="datetime-local" class="w-full border rounded px-3 py-2" required />
            </div>
          </div>

          <div class="text-sm text-gray-700">Dura√ß√£o: <span id="duracaoParada">-</span></div>
          <div id="alertOverlap" class="hidden text-sm text-red-600">‚ö†Ô∏è O intervalo informado se sobrep√µe a uma parada j√° registrada.</div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="cancelarParada" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Cancelar</button>
          <button type="submit" id="submitParadaBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar</button>
        </div>
      </form>

      <hr class="my-4" />

      <div>
        <h4 class="font-semibold mb-2">Hist√≥rico do dia</h4>
        <div id="historicoParadas" class="max-h-60 overflow-auto space-y-2 text-sm"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc,
    query, where, orderBy, serverTimestamp, onSnapshot, setDoc,
    enableMultiTabIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // ===== Configura√ß√£o do Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyCVLmT9ze8br21yZc7w3x6RyImy0_34NOk",
    authDomain: "irrigac-dc6ca.firebaseapp.com",
    projectId: "irrigac-dc6ca",
    storageBucket: "irrigac-dc6ca.firebasestorage.app",
    messagingSenderId: "410561274798",
    appId: "1:410561274798:web:4b2a494aefad676262de3f",
    measurementId: "G-9C2SDV3NNR"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== Persist√™ncia Offline (IndexedDB + Multi-Aba) =====
  enableMultiTabIndexedDbPersistence(db).catch(err => {
    if (err.code === 'failed-precondition') {
      console.warn("Persist√™ncia offline n√£o habilitada: m√∫ltiplas abas abertas.");
    } else if (err.code === 'unimplemented') {
      console.warn("O navegador n√£o suporta persist√™ncia offline.");
    } else {
      console.warn("Erro ao habilitar persist√™ncia offline:", err);
    }
  });

  // ===== Fun√ß√µes utilit√°rias =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fatorCarreador = 0.006;

  function showMessage(text, type = "success") {
    const msgEl = $("#mensagem");
    msgEl.textContent = text;
    const styles = {
      success: "bg-green-100 text-green-700 border border-green-400",
      error: "bg-red-100 text-red-700 border border-red-400",
      sync: "bg-blue-100 text-blue-700 border border-blue-400"
    };
    msgEl.className = `p-3 rounded mb-4 ${styles[type] || styles.success}`;
    msgEl.classList.remove("hidden");
    
    clearTimeout(showMessage._t);
    if (type !== "sync") {
      showMessage._t = setTimeout(() => msgEl.classList.add("hidden"), 5000);
    }
  }

    // LISTA DE C√ìDIGOS DE PARADA (RESTAURADO)
    const codigosParada = [
      "937 - AGUARDANDO ELETRICISTA","957 - AGURDANDO MEC√ÇNICO INTERNO","903 - AGUARDANDO MEC√ÇNICO",
      "961 - ENTUPIMENTO","913 - FALTA DE COMB. / LUBRIF.","960 - FALTA ENERGIA","919 - HOR√ÅRIO PONTA",
      "921 - FALTA DE √ÅGUA","922 - FALTA DE VINHA√áA","911 - FALTA CAMINH√ÉO","963 - PARADA APLIC.ADUBO/HERB.",
      "924 - FALTA DE OPERADOR","964 - FALTA TUBULA√á√ÉO","975 - FALTA √ÅREA","959 - LIMPEZA LAVAGEM DO EQP.",
      "976 - PIVOTAGEM","977 - PARADA CONSERTO EXTERNO","978 - DESLIGAMENTO QUEIMA",
      "979 - AGUARDANDO LIBERA√á√ÉO √ÅREA/CARREGAMENTO","948 - AGUARDANDO CARREGAR",
      "982 - AGUARDANDO RECOLHimento CARRETEL","962 - DESCARREGANDO VINHA√áA","909 - ENTUPIMENTO/EMBUCHAMENTO",
      "917 - REFEI√á√ÉO","942 - PARADA IND√öSTRIA","907 - CLIMA","904 - AGUARDANDO ORDENS",
      "967 - AGUARDANDO P/MUDAN√áA","945 - REPARO ADUTORA","926 - FALTA TRATOR/TRANSBORDO",
      "968 - TEMPO DE AVAN√áO","969 - LIMPEZA TUBULA√á√ÉO","970 - ASPERS√ÉO COMPLEMENTAR",
      "972 - TEMPO APLIC.EXCEDIDO","974 - CARREGAMENTO VINHA√áA","929 - PARADA PROGRAMADA",
      "916 - MUDAN√áA DE √ÅREA","973 - SOLICITA√á√ÉO EQP. CARREGAMENTO","966 - AGUARDANDO ORDENS USINA"
    ];

    // LISTA DE PROBLEMAS PARA O CHECKBOX
    const problemasOpcoes = [
      "mangueira desacoplada", "mangueira rasgada/furada", "mangueira curta", "torre rachada", "girar torre", 
      "torre sem abrir/fechar", "torre trocar pino", "torre trocar junta", "barulho no motor", "barulho na bomba", 
      "vazamento na gaxeta", "vazamento no corpo da bomba", "eletro sem ligar/desligar", "botoeira quebrada", 
      "desarmado", "pega press√£o e desliga", "taboca arriada", "cabo descascado", "eletro em curto", 
      "taboca saindo fa√≠sca", "transformador sem fase", "correia do acoplamento quebrada", "rolamento da bomba", 
      "rolamento do motor", "pneu furado/baixo", "mudan√ßa de transformador"
    ];

    function todayYMD() {
      const d = new Date();
      const off = d.getTimezoneOffset(); d.setMinutes(d.getMinutes() - off);
      return d.toISOString().slice(0,10);
    }
    function toISOFromDatetimeLocal(v) {
        if (!v) return null;
        const d = new Date(v);
        return d.toISOString();
    }
    function fromISOToDatetimeLocal(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    }
    function formatDateTime(d) { try { return new Date(d).toLocaleString("pt-BR"); } catch { return "-"; } }

    function updateConnUI() {
      const online = navigator.onLine;
      $("#dotConexao").className = "inline-block w-3 h-3 rounded-full " + (online ? "bg-green-500" : "bg-orange-500");
      $("#txtConexao").textContent = online ? "Conectado" : "Offline";
    }
    window.addEventListener("online", updateConnUI);
    window.addEventListener("offline", updateConnUI);
    updateConnUI();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(err => console.warn("SW falhou:", err));
    }

    const COLLECTION = "Areas";
    const sections = {
      projetos: $("#content-projetos"),
      cadastro: $("#content-cadastro"),
      operador: $("#content-operador"),
      relatorios: $("#content-relatorios"),
    };
    const selectProjeto = $("#projeto");
    const filtroProjetoCadastro = $("#filtroProjetoCadastro");
    const filtroProjetoOperador = $("#filtroProjetoOperador");
    const filtroProjetoRel = $("#filtroProjetoRel");
    const listaAreasCadastro = document.getElementById("listaAreasCadastro");
    const listaAreasOperador = $("#listaAreasOperador");
    const filtroDataOperador = $("#filtroDataOperador");
    const filtroDataRel = $("#filtroDataRel");
    const filtroAreaIndividual = $("#filtroAreaIndividual");
    
    // --- L√ìGICA DE NAVEGA√á√ÉO E ABAS (MODIFICADA) ---
    const navContainer = $("#navContainer");
    const menuBtn = $("#menuAbasBtn");
    const menu = $("#menuAbas");
    const menuIcon = menuBtn.querySelector(".menu-icon");
    const desktopTabButtons = $$('nav[aria-label="Tabs"] > .tab-btn');

    // Abre/Fecha o menu mobile
    menuBtn.addEventListener("click", () => {
      menu.classList.toggle("hidden");
      requestAnimationFrame(() => {
        menu.classList.toggle("show");
        menuIcon.classList.toggle("open");
      });
    });

    // Fecha o menu ao clicar fora
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
        menu.classList.remove("show");
        menuIcon.classList.remove("open");
        setTimeout(() => menu.classList.add("hidden"), 200);
      }
    });

    // Fun√ß√£o para atualizar o menu mobile dinamicamente
    function atualizarMenuMobile(activeTabName) {
        const menuContainer = $("#menuAbas");
        const menuLabel = $("#menuAbasLabel");
        let menuHTML = '';
        let activeLabelHTML = '';

        desktopTabButtons.forEach(btn => {
            const tabName = btn.dataset.tab;
            const isBloqueada = btn.classList.contains('aba-bloqueada');
            const btnContent = btn.innerHTML;

            if (tabName === activeTabName) {
                activeLabelHTML = btnContent;
            } else {
                menuHTML += `<button data-tab="${tabName}"
                    class="tab-btn ${isBloqueada ? 'aba-bloqueada' : ''} block w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-gray-100">
                    ${btnContent}
                </button>`;
            }
        });

        menuLabel.innerHTML = activeLabelHTML;
        menuContainer.innerHTML = menuHTML;
    }
    
    // Centraliza o evento de clique para todas as abas (desktop e mobile)
    navContainer.addEventListener('click', (e) => {
      const tabButton = e.target.closest('.tab-btn');
      if (tabButton && !tabButton.classList.contains('aba-bloqueada')) {
        const tabName = tabButton.dataset.tab;
        switchTab(tabName);
        // Se a a√ß√£o veio do menu mobile aberto, fecha ele
        if (menu.classList.contains('show')) {
            menu.classList.remove("show");
            menuIcon.classList.remove("open");
            setTimeout(() => menu.classList.add("hidden"), 200);
        }
      }
    });

    function switchTab(name) {
      // Mostra a se√ß√£o correta
      Object.entries(sections).forEach(([k, sec]) => {
        sec.classList.toggle("hidden", k !== name);
      });
      // Atualiza o estado 'active' de todos os bot√µes de aba
      $$('.tab-btn').forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === name);
      });
      
      // Atualiza o menu mobile
      atualizarMenuMobile(name);
      
      observarAreas();
    }
    
    let editDocId = null;
    let isSyncing = false;
    let syncNotificationShown = false;
    filtroDataOperador.value = todayYMD();
    filtroDataRel.value = todayYMD();

    const PROJ_DOC_ID = "6YqsO6D3ATYKiBNvuP9s";
    const projetoDocRef = doc(db, "Projeto", PROJ_DOC_ID);
    let projetosCache = []; 
    onSnapshot(projetoDocRef, (snap) => {
        try {
            if (!snap.exists()) {
                setDoc(projetoDocRef, { Projeto_1: "Projeto Padr√£o" }, { merge: true }).catch(() => {});
                projetosCache = ["Projeto Padr√£o"];
            } else {
                const data = snap.data() || {};
                projetosCache = Object.values(data).map(p => String(p || "").trim()).filter(Boolean).sort();
            }
            preencherSelectsProjeto();
        } catch (e) { console.error("onSnapshot projetos:", e); showMessage("Erro ao observar projetos.", "error"); }
    }, (err) => { console.error("Snapshot projetos falhou:", err); showMessage("Erro ao carregar projetos.", "error"); });
    
    function preencherSelectsProjeto() {
        const optsCadastro = ['<option value="">-- Selecione um Projeto --</option>'];
        const optsFiltro = ['<option value="">-- Todos os Projetos --</option>'];
        projetosCache.forEach(p => {
            optsCadastro.push(`<option value="${p}">${p}</option>`);
            optsFiltro.push(`<option value="${p}">${p}</option>`);
        });
        selectProjeto.innerHTML = optsCadastro.join("");
        filtroProjetoCadastro.innerHTML = optsFiltro.join("");
        filtroProjetoOperador.innerHTML = optsFiltro.join("");
        filtroProjetoRel.innerHTML = optsFiltro.join("");
        renderListaProjetosUI();
    }
    const listaProjetosEl = $("#listaProjetos");
    function renderListaProjetosUI(){
      listaProjetosEl.innerHTML = "";
      if (!projetosCache.length) {
        listaProjetosEl.innerHTML = `<li class="text-sm text-gray-600">Nenhum projeto cadastrado.</li>`;
        return;
      }
      projetosCache.forEach((nome, idx)=>{
        const li = document.createElement("li");
        li.className = "flex items-center justify-between border rounded px-3 py-2";
        li.innerHTML = `
          <span>${nome}</span>
          <div class="flex gap-2">
            <button class="btnRenomear bg-yellow-400 px-2 py-1 rounded text-sm" data-idx="${idx}">Renomear</button>
            <button class="btnRemover bg-red-500 text-white px-2 py-1 rounded text-sm" data-idx="${idx}">Remover</button>
          </div>
        `;
        listaProjetosEl.appendChild(li);
      });
      listaProjetosEl.querySelectorAll(".btnRenomear").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const i = Number(btn.dataset.idx);
          const atual = projetosCache[i];
          const novo = prompt("Novo nome do projeto:", atual);
          if (!novo || !novo.trim()) return;
          await salvarProjetosList(projetosCache.map((p,ix)=> ix===i ? novo.trim() : p));
          showMessage("Projeto renomeado.");
        });
      });
      listaProjetosEl.querySelectorAll(".btnRemover").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const i = Number(btn.dataset.idx);
          if (!confirm("Remover este projeto da lista?")) return;
          const novaLista = projetosCache.filter((_,ix)=> ix!==i);
          await salvarProjetosList(novaLista);
          showMessage("Projeto removido.");
        });
      });
    }
    async function salvarProjetosList(lista){
      const payload = {};
      lista.forEach((p, i)=> payload[`Projeto_${i+1}`] = p);
      const snap = await getDoc(projetoDocRef);
      const atual = snap.exists() ? Object.keys(snap.data()||{}) : [];
      const updates = { ...payload };
      for (const k of atual) if (!payload[k]) updates[k] = null;
      await setDoc(projetoDocRef, updates, { merge: true });
    }
    $("#formProjeto").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const nome = $("#novoProjeto").value.trim();
      if (!nome) return showMessage("Informe o nome do projeto.", "error");
      const lista = Array.from(new Set([...(projetosCache||[]), nome])).sort();
      try{
        await salvarProjetosList(lista);
        $("#novoProjeto").value = "";
        showMessage("Projeto adicionado.");
      }catch(err){
        console.error(err);
        showMessage("Erro ao salvar projeto.", "error");
      }
    });

    // ===== L√≥gica de C√°lculo (Metros Lineares) =====
    const horasPlanejadasInput = $("#horasPlanejadas");
    const velocidadeCarretelInput = $("#velocidadeCarretel");
    const metrosLinearesInput = $("#metrosLineares");

    function calcularMetrosLineares() {
      const horas = parseFloat(horasPlanejadasInput.value) || 0;
      const velocidade = parseFloat(velocidadeCarretelInput.value) || 0;
      const metros = horas * velocidade;
      metrosLinearesInput.value = metros.toFixed(2);
    }

    horasPlanejadasInput.addEventListener("input", calcularMetrosLineares);
    velocidadeCarretelInput.addEventListener("input", calcularMetrosLineares);


    // ===== L√≥gica Principal de Dados (√Åreas) =====
    let unsubscribeAreas = null;
    function observarAreas() {
        if (unsubscribeAreas) unsubscribeAreas(); 
        const areasRef = collection(db, COLLECTION);
        unsubscribeAreas = onSnapshot(areasRef, (snapshot) => {
            const hasPending = snapshot.metadata.hasPendingWrites;
            const fromCache = snapshot.metadata.fromCache;
            if (hasPending) {
                showMessage("Altera√ß√µes salvas localmente. Sincronizando assim que houver conex√£o...", "sync");
                isSyncing = true;
                syncNotificationShown = false;
            } else if (isSyncing && !fromCache && !syncNotificationShown) {
                showMessage("Dados sincronizados com sucesso! ‚úîÔ∏è", "success");
                isSyncing = false;
                syncNotificationShown = true;
            }
            // NOVO: Coleta de √°reas para o filtro de relat√≥rio individual
            const areasData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            popularFiltroAreaIndividual(areasData);
            
            if (!sections.cadastro.classList.contains("hidden")) {
                listarAreasCadastro(snapshot);
            }
            if (!sections.operador.classList.contains("hidden")) {
                listarAreasOperador();
            }
        }, (err) => { console.error("Falha ao observar √°reas:", err); showMessage("N√£o foi poss√≠vel carregar os dados em tempo real.", "error"); });
    }

    // Fun√ß√£o para alterar o status de finalizada/ativa da √°rea
    async function toggleFinalizadaStatus(docId, newStatus) {
        const isFinalizing = newStatus === true;
        const confirmMsg = isFinalizing 
            ? "Tem certeza que deseja finalizar a irriga√ß√£o para esta √°rea? Ela n√£o aparecer√° mais para o operador."
            : "Tem certeza que deseja reativar a irriga√ß√£o para esta √°rea? Ela voltar√° a aparecer para o operador.";

        if (!confirm(confirmMsg)) return;

        try {
            await updateDoc(doc(db, COLLECTION, docId), { finalizada: newStatus });
            showMessage(isFinalizing ? "√Årea finalizada com sucesso." : "√Årea reativada com sucesso.");
        } catch (e) {
            console.error(e);
            showMessage("Erro ao alterar status da √°rea.", "error");
        }
    }

    // MODIFICADO: A listagem agora exibe o status "Finalizada" e bot√µes condicionais
    async function listarAreasCadastro(snapshot) {
        listaAreasCadastro.innerHTML = `<div class="text-sm text-gray-600">Carregando...</div>`;
        try {
            const snap = snapshot || await getDocs(collection(db, COLLECTION));
            const filtro = (filtroProjetoCadastro.value || "").trim();
            const frag = document.createDocumentFragment();
            let count = 0;

            snap.forEach(docSnap => {
                const data = docSnap.data();
                if (filtro && data.projeto !== filtro) return;

                const isFinalizada = data.finalizada === true;
                const card = document.createElement("div");
                // Adiciona estilo visual para √°reas finalizadas
                card.className = `bg-white rounded shadow p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 ${isFinalizada ? 'opacity-60 bg-gray-50' : ''}`;
                
                const atualizado = data.atualizadoEm ? formatDateTime(data.atualizadoEm) : "-";

                // Bot√µes mudam com base no status da √°rea
const buttonsHTML = isFinalizada
  ? `<button class="btnReativar w-full bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-id="${docSnap.id}">Reativar Irriga√ß√£o</button>
      <button class="btnEditar bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-400" data-id="${docSnap.id}">Editar</button>` // 
  : `<button class="btnEditar bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-400" data-id="${docSnap.id}">Editar</button>
      <button class="btnFinalizar bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-id="${docSnap.id}">Finalizar Irriga√ß√£o</button>`;

                card.innerHTML = `
                  <div class="flex-1 flex flex-col gap-1 text-sm">
                    <div class="flex items-center gap-4">
                      <span class="font-semibold text-base text-blue-900">${data.bloco || "-"}</span>
                      ${isFinalizada ? '<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">IRRIGA√á√ÉO FINALIZADA</span>' : ''}
                    </div>
                    <div><strong>Projeto:</strong> ${data.projeto || "-"}</div>
                    <div><strong>Bombeamento:</strong> ${data.bombeamento || "-"}</div>
                    <div><strong>Carretel:</strong> ${data.numeroCarretel || "-"}</div>
                    <div><strong>Velocidade:</strong> ${data.velocidadeCarretel || "-"} m/h</div>
                    <div><strong>Metros Lineares:</strong> ${data.metrosLineares || "-"} m</div>
                    <div><strong>Vaz√£o:</strong> ${data.vazao || "-"}</div>
                    <div><strong>Croqui:</strong> ${data.numeroCroqui || "-"}</div>
                    <div><strong>Pr√≥x. Bloco:</strong> ${data.proxBloco || "-"}</div>
                  </div>
                  <div class="flex flex-col gap-2 w-full md:w-auto self-stretch justify-end">
                    ${buttonsHTML}
                    <button class="btnExcluir bg-red-400 text-white px-3 py-1 rounded hover:bg-gray-500 text-white" data-id="${docSnap.id}">Excluir</button>
                  </div>
                `;
                frag.appendChild(card);
                count++;
            });

            listaAreasCadastro.innerHTML = "";
            listaAreasCadastro.appendChild(frag);

            // Adiciona listeners para os novos bot√µes
            listaAreasCadastro.querySelectorAll(".btnFinalizar").forEach(b => b.addEventListener("click", () => toggleFinalizadaStatus(b.dataset.id, true)));
            listaAreasCadastro.querySelectorAll(".btnReativar").forEach(b => b.addEventListener("click", () => toggleFinalizadaStatus(b.dataset.id, false)));
            
            listaAreasCadastro.querySelectorAll(".btnEditar").forEach(b => b.addEventListener("click", () => carregarParaEdicao(b.dataset.id)));
            listaAreasCadastro.querySelectorAll(".btnExcluir").forEach(b => b.addEventListener("click", async () => {
                if (!confirm("Deseja realmente EXCLUIR esta √°rea? Esta a√ß√£o n√£o pode ser desfeita.")) return;
                try {
                    await deleteDoc(doc(db, COLLECTION, b.dataset.id));
                    showMessage("√Årea exclu√≠da com sucesso.");
                } catch (e) { console.error(e); showMessage("Erro ao excluir √°rea.", "error"); }
            }));

            if (!count) listaAreasCadastro.innerHTML = `<div class="text-sm text-gray-600">Nenhuma √°rea para o filtro.</div>`;
        } catch (e) { console.error(e); listaAreasCadastro.innerHTML = `<div class="text-sm text-red-600">Erro ao carregar √°reas.</div>`; }
    }

async function carregarParaEdicao(id) {
    try {
        const ref = doc(db, COLLECTION, id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
            return showMessage("√Årea n√£o encontrada.", "error");
        }

        const d = snap.data();

        // Carrega todos os dados do banco de dados para o formul√°rio
        $("#projeto").value = d.projeto || "";
        $("#bombeamento").value = d.bombeamento || "";
        $("#bloco").value = d.bloco || "";
        $("#proxBloco").value = d.proxBloco || "";
        $("#numeroEletrobomba").value = d.numeroEletrobomba || "";
        $("#numeroCarretel").value = d.numeroCarretel || "";
        $("#tipoArea").value = d.tipoArea || "";
        $("#tipoIrrigacao").value = d.tipoIrrigacao || "";
        $("#tipoProduto").value = d.tipoProduto || "";
        $("#horasPlanejadas").value = Number(d.horasPlanejadas || 0);
        $("#velocidadeCarretel").value = Number(d.velocidadeCarretel || 0); // NOVO
        $("#metrosLineares").value = Number(d.metrosLineares || 0).toFixed(2); // NOVO
        $("#numeroCroqui").value = d.numeroCroqui || "";
        $("#vazao").value = d.vazao || "";
        
        editDocId = id;
        $("#cancelarEdicao").classList.remove("hidden");
        switchTab("cadastro");
        showMessage("√Årea carregada para edi√ß√£o.");
    } catch (e) {
        console.error(e);
        showMessage("Erro ao carregar √°rea.", "error");
    }
}
    $("#cancelarEdicao").addEventListener("click", () => {
        editDocId = null;
        $("#formArea").reset();
        $("#cancelarEdicao").classList.add("hidden");
    });

    $("#formArea").addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
            projeto: $("#projeto").value.trim(), bombeamento: $("#bombeamento").value.trim(),
            bloco: $("#bloco").value.trim(), proxBloco: $("#proxBloco").value.trim(),
            numeroEletrobomba: $("#numeroEletrobomba").value.trim(), numeroCarretel: $("#numeroCarretel").value.trim(),
            tipoArea: $("#tipoArea").value.trim(), tipoIrrigacao: $("#tipoIrrigacao").value.trim(),
            tipoProduto: $("#tipoProduto").value.trim(), horasPlanejadas: Number($("#horasPlanejadas").value || 0),
            velocidadeCarretel: Number($("#velocidadeCarretel").value || 0), // NOVO
            metrosLineares: Number($("#metrosLineares").value || 0), // NOVO
            numeroCroqui: $("#numeroCroqui").value.trim(), vazao: $("#vazao").value.trim(),
            atualizadoEm: new Date().toISOString()
        };

        const requiredFields = Array.from($("#formArea").querySelectorAll("[required]"));
        if (requiredFields.some(input => !input.value.trim())) {
            return showMessage("Preencha todos os campos obrigat√≥rios.", "error");
        }

        try {
            if (editDocId) {
                await updateDoc(doc(db, COLLECTION, editDocId), payload);
                showMessage("√Årea atualizada com sucesso.");
            } else {
                payload.criadoEm = new Date().toISOString();
                payload.finalizada = false; 
                await addDoc(collection(db, COLLECTION), payload);
                showMessage("√Årea cadastrada com sucesso.");
            }
            editDocId = null;
            $("#formArea").reset();
            $("#cancelarEdicao").classList.add("hidden");
        } catch (e) { console.error(e); showMessage("Erro ao salvar √°rea.", "error"); }
    });

    filtroProjetoCadastro.addEventListener("change", () => listarAreasCadastro());

    $("#btnFiltrarOperador").addEventListener("click", listarAreasOperador);
    
    async function listarAreasOperador() {
      listaAreasOperador.innerHTML = `<div class="text-sm text-gray-600">Carregando...</div>`;
      try {
        const ymd = filtroDataOperador.value || todayYMD();
        const snap = await getDocs(collection(db, COLLECTION));
        const filtroProj = (filtroProjetoOperador.value || "").trim();
        const cards = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.finalizada === true) return;
          
          if (filtroProj && data.projeto !== filtroProj) return;
          cards.push({ id: docSnap.id, ...data });
        });

        const frag = document.createDocumentFragment();
        if (cards.length === 0) {
            listaAreasOperador.innerHTML = `<div class="text-sm text-gray-600">Nenhuma √°rea ativa para os filtros.</div>`;
            return;
        }

        for (const area of cards) {
          const card = document.createElement("div");
          card.className = "bg-white rounded shadow p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4";
          const statusEl = document.createElement("div");
          statusEl.className = "text-xs";
          statusEl.textContent = "verificando...";
          (async () => {
            const st = await getStatusDia(area.id, ymd);
            const badge = document.createElement("span");
            badge.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium";
            if (st === "com_parada") { badge.className += " bg-red-100 text-red-800"; badge.textContent = "Com parada"; }
            else if (st === "sem_parada") { badge.className += " bg-green-100 text-green-800"; badge.textContent = "Sem parada"; }
            else { badge.className += " bg-gray-100 text-gray-800"; badge.textContent = "Sem registros"; }
            statusEl.innerHTML = ""; statusEl.appendChild(badge);
          })();

          card.innerHTML = `
            <div class="text-sm">
              <div class="font-semibold text-base text-blue-900">${area.bloco || "-"}</div>
              <div><strong>Projeto:</strong> ${area.projeto || "-"}</div>
              <div><strong>Bombeamento:</strong> ${area.bombeamento || "-"}</div>
              <div><strong>Carretel:</strong> ${area.numeroCarretel || "-"}</div>
              <div><strong>Velocidade:</strong> ${area.velocidadeCarretel || "-"} m/h</div>
              <div><strong>Metros Lineares:</strong> ${area.metrosLineares || "-"} m</div>
              <div><strong>Vaz√£o:</strong> ${area.vazao || "-"}</div>
              <div><strong>Horas Planejadas:</strong> ${Number(area.horasPlanejadas||0)}</div>
              <div><strong>Croqui:</strong> ${area.numeroCroqui || "-"}</div>
              <div><strong>Pr√≥x. Bloco:</strong> ${area.proxBloco || "-"}</div>
            </div>
            <div class="flex flex-col md:items-end gap-2 w-full md:w-auto">
              <div class="mb-1" id="statusWrap"></div>
              <button class="btnAddParada bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full md:w-auto">+ Parada</button>
              <button class="btnVerHistorico bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 w-full md:w-auto">Hist√≥rico (${ymd})</button>
            </div>
          `;

          card.querySelector("#statusWrap").appendChild(statusEl);
          card.querySelector(".btnAddParada").addEventListener("click", () => abrirModal(area));
          card.querySelector(".btnVerHistorico").addEventListener("click", () => abrirModal(area));
          frag.appendChild(card);
        }
        listaAreasOperador.innerHTML = "";
        listaAreasOperador.appendChild(frag);
      } catch (e) { console.error(e); listaAreasOperador.innerHTML = `<div class="text-sm text-red-600">Erro ao carregar √°reas.</div>`; }
    }
    

    const modalParada = $("#modalParada");
    const closeModalBtn = $("#closeModal");
    const cancelarParadaBtn = $("#cancelarParada");
    const formParada = $("#formParada");
    const camposParada = $("#camposParada");
    const duracaoParadaEl = $("#duracaoParada");
    const overlapAlert = $("#alertOverlap");
    let areaAtual = null;
    let editParadaId = null; // NOVO: para controlar edi√ß√£o de parada

    formParada.querySelectorAll('input[name="houveParadaModal"]').forEach(r => {
      r.addEventListener("change", (ev) => {
        const selected = ev.target;
        if (selected.value === "sim" && selected.checked) camposParada.classList.remove("hidden");
        else if (selected.value === "nao" && selected.checked) camposParada.classList.add("hidden");
      });
    });
    function calcularDuracaoModal() {
      const inicio = $("#inicioParada").value;
      const fim = $("#fimParada").value;
      overlapAlert.classList.add("hidden");
      if (!inicio || !fim) { duracaoParadaEl.textContent = "-"; return 0; }
      const di = new Date(inicio), df = new Date(fim);
      if (isNaN(di) || isNaN(df) || df <= di) { duracaoParadaEl.textContent = "-"; return 0; }
      const minutos = (df - di) / 60000;
      duracaoParadaEl.textContent = `${minutos.toFixed(0)} min (${(minutos/60).toFixed(2)} h)`;
      return minutos / 60;
    }
    $("#inicioParada").addEventListener("input", calcularDuracaoModal);
    $("#fimParada").addEventListener("input", calcularDuracaoModal);
    
    const problemaOutroCheckbox = $("#problemaOutro");
    const descricaoProblemaOutroTextarea = $("#descricaoProblemaOutro");
    problemaOutroCheckbox.addEventListener('change', () => {
        descricaoProblemaOutroTextarea.classList.toggle('hidden', !problemaOutroCheckbox.checked);
    });

    function abrirModal(areaDoc, paradaParaEditar = null) {
      areaAtual = areaDoc;
      editParadaId = paradaParaEditar ? paradaParaEditar.id : null;

      $("#modalTitle").textContent = editParadaId ? "Editar Parada" : "Registrar Parada";
      $("#submitParadaBtn").textContent = editParadaId ? "Salvar Altera√ß√µes" : "Salvar";

      $("#modalInfoArea").innerHTML = `
        <div><strong>Projeto:</strong> ${areaDoc.projeto || "-"}</div>
        <div><strong>Bloco:</strong> ${areaDoc.bloco || "-"}</div>
        <div><strong>Bombeamento:</strong> ${areaDoc.bombeamento || "-"}</div>
      `;
      formParada.reset(); 
      descricaoProblemaOutroTextarea.value = '';
      descricaoProblemaOutroTextarea.classList.add('hidden');
      camposParada.classList.add("hidden"); 
      duracaoParadaEl.textContent = "-"; 
      overlapAlert.classList.add("hidden");
      
      if (paradaParaEditar) {
          const p = paradaParaEditar;
          $('input[name="houveParadaModal"][value="sim"]').checked = true;
          camposParada.classList.remove("hidden");
          $("#codParada").value = p.codParada || "";
          $("#horimetroInicial").value = p.horimetroInicial || "";
          $("#horimetroFinal").value = p.horimetroFinal || "";
          $("#equipamentoProblemaModal").value = p.equipamentoProblema || "";
          $("#descricaoParadaCodigoSelect").value = p.descricaoParadaCodigo || "";
          
          $$('input[name="problema"]').forEach(cb => cb.checked = false);
          if (Array.isArray(p.descricaoProblema)) {
              p.descricaoProblema.forEach(prob => {
                  const cb = $(`input[name="problema"][value="${prob}"]`);
                  if (cb) cb.checked = true;
              });
          }
          
          if (p.descricaoProblemaOutro) {
              problemaOutroCheckbox.checked = true;
              descricaoProblemaOutroTextarea.value = p.descricaoProblemaOutro;
              descricaoProblemaOutroTextarea.classList.remove('hidden');
          }

          $("#inicioParada").value = fromISOToDatetimeLocal(p.inicioParada);
          $("#fimParada").value = fromISOToDatetimeLocal(p.fimParada);
          calcularDuracaoModal();
      } else {
          const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          const in30 = new Date(now); in30.setMinutes(in30.getMinutes() + 30);
          $("#inicioParada").value = now.toISOString().slice(0,16);
          $("#fimParada").value = in30.toISOString().slice(0,16);
      }

      modalParada.classList.remove("hidden"); modalParada.classList.add("flex");
      carregarHistoricoParadas(areaDoc.id, filtroDataOperador.value);
    }
    function fecharModal(){ 
        modalParada.classList.add("hidden"); 
        modalParada.classList.remove("flex"); 
        areaAtual = null; 
        editParadaId = null;
    }
    closeModalBtn.addEventListener("click", fecharModal);
    cancelarParadaBtn.addEventListener("click", fecharModal);
    modalParada.addEventListener("click", (e) => { if (e.target === modalParada) fecharModal(); });

    async function carregarHistoricoParadas(areaId, ymd) {
      const cont = $("#historicoParadas");
      cont.innerHTML = `<div class="text-gray-600 text-sm">Carregando...</div>`;
      try {
        const start = new Date(ymd + "T00:00:00.000Z");
        const end = new Date(ymd + "T23:59:59.999Z");
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const qy = query(ref, where("inicioParada", ">=", `${ymd}T00:00:00`), where("inicioParada", "<=", `${ymd}T23:59:59`), orderBy("inicioParada", "asc"));
        const snap = await getDocs(qy);
        if (snap.empty) { cont.innerHTML = `<div class="text-gray-600 text-sm">Sem registros para o dia.</div>`; return []; }
        
        const itens = [];
        snap.forEach(s => itens.push({ id: s.id, ...s.data() }));

        const frag = document.createDocumentFragment();
        itens.forEach(p => {
            const linha = document.createElement("div");
            const durh = p.duracaoHoras != null ? Number(p.duracaoHoras).toFixed(2) : "-";
            
            const descricoes = Array.isArray(p.descricaoProblema) && p.descricaoProblema.length > 0
                ? p.descricaoProblema.join(', ')
                : "N/A";

            let problemaHTML = `<div><strong>C√≥d. Parada:</strong> ${p.descricaoParadaCodigo || "-"}</div>`;
            problemaHTML += `<div><strong>Problema(s):</strong> ${descricoes}</div>`;

            if (p.descricaoProblemaOutro) {
                problemaHTML += `<div><strong>Outro:</strong> ${p.descricaoProblemaOutro}</div>`;
            }

            const adminButtons = isAdmin ? `
                <div class="flex gap-2 mt-2">
                    <button class="btnEditarParada text-xs bg-yellow-400 text-white px-2 py-1 rounded" data-parada-id="${p.id}">Editar</button>
                    <button class="btnExcluirParada text-xs bg-red-500 text-white px-2 py-1 rounded" data-parada-id="${p.id}">Excluir</button>
                </div>
            ` : '';

            linha.className = "border rounded p-2";
            linha.innerHTML = `
              <div><strong>Houve:</strong> ${p.houveParada ? "Sim" : "N√£o"}</div>
              ${p.houveParada ? `
                <div><strong>Equip.:</strong> ${p.codParada || "-"} ${p.equipamentoProblema ? "‚Ä¢ " + p.equipamentoProblema : ""}</div>
                ${problemaHTML}
                <div><strong>In√≠cio:</strong> ${formatDateTime(p.inicioParada)} ‚Ä¢ <strong>Fim:</strong> ${formatDateTime(p.fimParada)}</div>
                <div><strong>Dura√ß√£o:</strong> ${durh} h</div>
                
                <div><strong>Hor√≠metro Inicial:</strong> ${p.horimetroInicial || "-"}</div>
                <div><strong>Hor√≠metro Final:</strong> ${p.horimetroFinal || "-"}</div>
                ${adminButtons}
              ` : ``}
              <div class="text-xs text-gray-500"><em>Registrado:</em> ${p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleString("pt-BR") : "-"}</div>
            `;
            frag.appendChild(linha);
        });
        cont.innerHTML = ""; 
        cont.appendChild(frag);

        cont.querySelectorAll('.btnEditarParada').forEach(btn => {
            btn.addEventListener('click', () => {
                const paradaId = btn.dataset.paradaId;
                const paradaData = itens.find(item => item.id === paradaId);
                if (paradaData) {
                    abrirModal(areaAtual, paradaData);
                }
            });
        });

        cont.querySelectorAll('.btnExcluirParada').forEach(btn => {
            btn.addEventListener('click', () => {
                const paradaId = btn.dataset.paradaId;
                excluirParada(areaId, paradaId);
            });
        });

        return itens;
      } catch (e) { console.error(e); cont.innerHTML = `<div class="text-red-600 text-sm">Erro ao carregar hist√≥rico.</div>`; return []; }
    }

    async function excluirParada(areaId, paradaId) {
        if (!confirm("Tem certeza que deseja excluir este registro de parada?")) return;
        try {
            const paradaRef = doc(db, COLLECTION, areaId, "paradas", paradaId);
            await deleteDoc(paradaRef);
            showMessage("Registro de parada exclu√≠do com sucesso.");
            carregarHistoricoParadas(areaId, filtroDataOperador.value);
        } catch (e) {
            console.error("Erro ao excluir parada:", e);
            showMessage("Erro ao excluir o registro.", "error");
        }
    }

    function existeSobreposicao(registros, novoInicioIso, novoFimIso, idSendoEditado) {
      const ni = new Date(novoInicioIso).getTime(); const nf = new Date(novoFimIso).getTime();
      return registros.some(r => {
        if (r.id === idSendoEditado) return false; // N√£o comparar com ele mesmo
        if (!r.houveParada) return false;
        const ri = new Date(r.inicioParada).getTime(); const rf = new Date(r.fimParada).getTime();
        return ni < rf && nf > ri;
      });
    }
    formParada.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!areaAtual?.id) return showMessage("√Årea inv√°lida para registro.", "error");
      const houveRad = formParada.querySelector('input[name="houveParadaModal"]:checked');
      if (!houveRad) return showMessage("Informe se houve parada.", "error");
      const houve = houveRad.value === "sim";
      let payload = { houveParada: houve, createdAt: serverTimestamp() };
      if (houve) {
        const codParada = $("#codParada").value;
        const descricaoCodigo = $("#descricaoParadaCodigoSelect").value;
        const inicio = $("#inicioParada").value; const fim = $("#fimParada").value;
        const horimetroInicial = $("#horimetroInicial").value.trim();const horimetroFinal = $("#horimetroFinal").value.trim();
        const di = new Date(inicio), df = new Date(fim);

        const descricoesSelecionadas = Array.from($$('input[name="problema"]:checked')).map(cb => cb.value);
        const descricaoOutro = problemaOutroCheckbox.checked ? descricaoProblemaOutroTextarea.value.trim() : "";

        if (!codParada || !descricaoCodigo || isNaN(di) || isNaN(df) || df <= di) return showMessage("Verifique tipo de equipamento, c√≥digo da parada e hor√°rios.", "error");
        if (descricoesSelecionadas.length === 0 && !descricaoOutro) return showMessage("Selecione ao menos um problema ou descreva em 'Outro'.", "error");

        const inicioIso = toISOFromDatetimeLocal(inicio); const fimIso = toISOFromDatetimeLocal(fim);
        const historico = await carregarHistoricoParadas(areaAtual.id, $("#filtroDataOperador").value);
        if (existeSobreposicao(historico, inicioIso, fimIso, editParadaId)) { 
            overlapAlert.classList.remove("hidden"); 
            return; 
        } else { 
            overlapAlert.classList.add("hidden"); 
        }
        const durHoras = (df - di) / 3600000;
        payload = { 
            ...payload, 
            codParada, 
            descricaoParadaCodigo: descricaoCodigo,
            descricaoProblema: descricoesSelecionadas,
            descricaoProblemaOutro: descricaoOutro,
            equipamentoProblema: $("#equipamentoProblemaModal").value.trim(), 
            inicioParada: inicioIso, 
            fimParada: fimIso, 
            duracaoHoras: Number(durHoras.toFixed(2)),
            horimetroInicial: horimetroInicial || null,
            horimetroFinal: horimetroFinal || null, 
        };
      }
      try {
        if (editParadaId) {
            const paradaRef = doc(db, COLLECTION, areaAtual.id, "paradas", editParadaId);
            await updateDoc(paradaRef, payload);
            showMessage("Parada atualizada com sucesso!");
        } else {
            const subRef = collection(doc(db, COLLECTION, areaAtual.id), "paradas");
            await addDoc(subRef, payload);
            showMessage("Parada registrada com sucesso!");
        }
        
        fecharModal();

      } catch (e) { console.error(e); showMessage("Erro ao salvar parada.", "error"); }
    });


    async function getStatusDia(areaId, ymd) {
      try {
        const start = new Date(ymd + "T00:00:00.000Z"); const end = new Date(ymd + "T23:59:59.999Z");
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const qy = query(ref,  where("inicioParada", ">=", `${ymd}T00:00:00`),  where("inicioParada", "<=", `${ymd}T23:59:59`));
        const snap = await getDocs(qy);
        if (snap.empty) return "sem_registro";
        let comParada = false;
        snap.forEach(s => { if (s.data().houveParada) comParada = true; });
        return comParada ? "com_parada" : "sem_parada";
      } catch (e) { console.error("status dia erro:", e); return "sem_registro"; }
    }


    // ===== Exporta√ß√µes (Operador) =====
    $("#btnExportCSV").addEventListener("click", async () => {
      const ymd = filtroDataOperador.value || todayYMD();
      const dados = await coletarParadasDia(ymd);
      const csv = toCSV(dados, true);
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      downloadBlob(blob, `paradas_${ymd}.csv`);
    });

    $("#btnExportPDF").addEventListener("click", async () => {
      const ymd = filtroDataOperador.value || todayYMD();
      const dados = await coletarParadasDia(ymd);
      gerarPDF(dados, ymd, "Relat√≥rio de Paradas");
    });

    async function coletarParadasDia(ymd) {
      const start = new Date(ymd + "T00:00:00.000Z");
      const end = new Date(ymd + "T23:59:59.999Z");
      const areasSnap = await getDocs(collection(db, COLLECTION));
      const all = [];

      for (const areaDoc of areasSnap.docs) {
        const area = areaDoc.data();
        const ref = collection(doc(db, COLLECTION, areaDoc.id), "paradas");

        const qy = query(
          ref,
          where("inicioParada", ">=", start.toISOString()),
          where("inicioParada", "<=", end.toISOString()),
          orderBy("inicioParada", "asc")
        );

        const paradasSnap = await getDocs(qy);
        if (paradasSnap.empty) {
            all.push({
                projeto: area.projeto || "",
                bloco: area.bloco || "",
                bombeamento: area.bombeamento || "",
                numeroEletrobomba: area.numeroEletrobomba || "",
                numeroCarretel: area.numeroCarretel || "",
                descricaoCompletaParada: "N√£o houve parada",
                //... outros campos da √°rea
            });
        } else {
            paradasSnap.forEach(p => {
              const dados = p.data();
              const descricaoProblemas = (Array.isArray(dados.descricaoProblema) ? dados.descricaoProblema.join('; ') : '');
              const descricaoOutro = dados.descricaoProblemaOutro ? `; Outro: ${dados.descricaoProblemaOutro}` : '';
              const descricaoCompleta = dados.houveParada 
                ? `${dados.descricaoParadaCodigo || ''} (${descricaoProblemas}${descricaoOutro})`
                : "N√£o houve parada";
              
              all.push({
                projeto: area.projeto || "",
                bloco: area.bloco || "",
                bombeamento: area.bombeamento || "",
                numeroEletrobomba: area.numeroEletrobomba || "",
                numeroCarretel: area.numeroCarretel || "",
                velocidadeCarretel: area.velocidadeCarretel || "",
                metrosLineares: area.metrosLineares || "",
                vazao: area.vazao || "",
                tipoArea: area.tipoArea || "",
                tipoIrrigacao: area.tipoIrrigacao || "",
                tipoProduto: area.tipoProduto || "",
                horasPlanejadas: Number(area.horasPlanejadas||0).toFixed(2),
                numeroCroqui: area.numeroCroqui || "",
                proxBloco: area.proxBloco || "",
                descricaoCompletaParada: descricaoCompleta,
                inicioParada: formatDateTime(dados.inicioParada),
                fimParada: formatDateTime(dados.fimParada),
                duracaoHoras: dados.duracaoHoras != null ? Number(dados.duracaoHoras).toFixed(2) : "",
                registradoEm: dados.createdAt?.seconds
                  ? new Date(dados.createdAt.seconds * 1000).toLocaleString("pt-BR")
                  : ""
              });
            });
        }
      }
      return all;
    }

    function toCSV(dados, useSemicolon = false) {
      if (!dados.length) return "Sem dados";
      const sep = useSemicolon ? ";" : ",";
      const colunas = Object.keys(dados[0]);
      const header = colunas.join(sep);
      const linhas = dados.map(row =>
        colunas.map(c => `"${(row[c] ?? "").toString().replace(/"/g, '""')}"`).join(sep)
      );
      return header + "\n" + linhas.join("\n");
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function gerarPDF(dados, ymd, titulo="Relat√≥rio") {
      if (!dados.length) {
        showMessage("Sem dados para exportar.", "error");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });

      doc.setFontSize(14);
      doc.text(`${titulo} - ${ymd}`, 14, 15);

      const colunas = Object.keys(dados[0]);
      const linhas = dados.map(d => colunas.map(c => d[c] || ""));

      doc.autoTable({
        head: [colunas],
        body: linhas,
        startY: 20,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [37, 99, 235] }
      });

      doc.save(`${titulo.replaceAll(" ","_").toLowerCase()}_${ymd}.pdf`);
    }

    // ===== RELAT√ìRIOS CONSOLIDADOS =====
    $("#btnGerarRelatorio").addEventListener("click", gerarRelatoriosUI);
    $("#btnExportCSVRel").addEventListener("click", async () => {
      const { ymd, linhas } = await calcularRelatorio();
      const csv = toCSV(linhas, true);
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      downloadBlob(blob, `relatorio_${ymd}.csv`);
    });
    $("#btnExportPDFRel").addEventListener("click", async () => {
      const { ymd, linhas } = await calcularRelatorio();
      gerarPDF(linhas, ymd, "Relat√≥rio Consolidado");
    });

    async function calcularRelatorio(){
      const ymd = filtroDataRel.value || todayYMD();
      const filtroProj = (filtroProjetoRel.value || "").trim();
      const start = new Date(ymd + "T00:00:00.000Z");
      const end = new Date(ymd + "T23:59:59.999Z");

      const areasSnap = await getDocs(collection(db, COLLECTION));
      const areas = areasSnap.docs
        .map(d=>({ id: d.id, ...d.data() }))
        .filter(a=> !filtroProj || a.projeto === filtroProj);

      const linhas = [];
      let totalPlan = 0, totalPar = 0, totalMetrosPlano = 0, totalMetrosReal = 0;
      let totalHectaresPlano = 0, totalHectaresReal = 0, totalMetrosHorimetro = 0;

      for (const area of areas){
        const ref = collection(doc(db, COLLECTION, area.id), "paradas");
        const qy = query(ref,
          where("inicioParada", ">=", start.toISOString()),
          where("inicioParada", "<=", end.toISOString())
        );
        const snap = await getDocs(qy);
        let horasParadas = 0;
        let horasHorimetro = 0;
        snap.forEach(s=>{
          const p = s.data();
          if (p.houveParada && p.duracaoHoras) horasParadas += Number(p.duracaoHoras)||0;
          if (p.horimetroFinal && p.horimetroInicial) {
              horasHorimetro += (Number(String(p.horimetroFinal).replace(',','.')) - Number(String(p.horimetroInicial).replace(',','.')));
          }
        });

        const planejadas = Number(area.horasPlanejadas||0);
        const rodadas = Math.max(0, planejadas - horasParadas);
        const efic = planejadas > 0 ? (rodadas/planejadas)*100 : 0;
        
        const velocidade = Number(area.velocidadeCarretel || 0);
        const metrosPlano = Number(area.metrosLineares || 0);
        const metrosReal = rodadas * velocidade;
        const metrosRealHorimetro = horasHorimetro * velocidade;
        const hectaresPlano = metrosPlano * fatorCarreador;
        const hectaresReal = metrosReal * fatorCarreador;


        totalPlan += planejadas;
        totalPar += horasParadas;
        totalMetrosPlano += metrosPlano;
        totalMetrosReal += metrosReal;
        totalHectaresPlano += hectaresPlano;
        totalHectaresReal += hectaresReal;
        totalMetrosHorimetro += metrosRealHorimetro;


        linhas.push({
          numeroCroqui: area.numeroCroqui || "",
          projeto: area.projeto || "",
          bloco: area.bloco || "",
          bombeamento: area.bombeamento || "",
          eletrobomba: area.numeroEletrobomba || "",
          carretel: area.numeroCarretel || "",
          horasPlanejadas: planejadas.toFixed(2),
          horasParadas: horasParadas.toFixed(2),
          horasRodadas: rodadas.toFixed(2),
          eficiencia: `${efic.toFixed(1)}%`,
          metrosLinearesPlano: metrosPlano.toFixed(2),
          metrosLinearesReal: metrosReal.toFixed(2),
          hectaresPlano: hectaresPlano.toFixed(2),
          hectaresReal: hectaresReal.toFixed(2),
        });
      }

      const rodadasTot = Math.max(0, totalPlan - totalPar);
      const eficTot = totalPlan > 0 ? (rodadasTot/totalPlan)*100 : 0;

      return {
        ymd,
        sum: { 
          totalPlan, totalPar, rodadasTot, eficTot, 
          totalMetrosPlano, totalMetrosReal, 
          totalHectaresPlano, totalHectaresReal,
          totalMetrosHorimetro
        },
        linhas
      };
    }

    async function gerarRelatoriosUI(){
      const sumPlane = $("#sumPlanejadas");
      const sumPar = $("#sumParadas");
      const sumRod = $("#sumRodadas");
      const sumEf = $("#sumEficiencia");
      const sumMetrosPlanoEl = $("#sumMetrosPlano");
      const sumMetrosRealEl = $("#sumMetrosReal");
      const sumHectaresPlanoEl = $("#sumHectaresPlano");
      const sumHectaresRealEl = $("#sumHectaresReal");
      const sumMetrosHorimetroEl = $("#sumMetrosHorimetro");
      const tabelaRel = $("#tabelaRel");

      tabelaRel.innerHTML = `<div class="text-sm text-gray-600">Calculando...</div>`;
      const { sum, linhas } = await calcularRelatorio();

      sumPlane.textContent = sum.totalPlan.toFixed(2);
      sumPar.textContent = sum.totalPar.toFixed(2);
      sumRod.textContent = sum.rodadasTot.toFixed(2);
      sumEf.textContent = `${sum.eficTot.toFixed(1)}%`;
      sumMetrosPlanoEl.textContent = sum.totalMetrosPlano.toFixed(2);
      sumMetrosRealEl.textContent = sum.totalMetrosReal.toFixed(2);
      sumHectaresPlanoEl.textContent = sum.totalHectaresPlano.toFixed(2);
      sumHectaresRealEl.textContent = sum.totalHectaresReal.toFixed(2);
      sumMetrosHorimetroEl.textContent = sum.totalMetrosHorimetro.toFixed(2);

      if (!linhas.length){
        tabelaRel.innerHTML = `<div class="text-sm text-gray-600">Sem dados para os filtros.</div>`;
        return;
      }

      const table = document.createElement("div");
      table.className = "overflow-auto";
      const headers = ["Croqui", "Projeto","Bloco","Bombeamento","Eletrobomba","Carretel","H. Plan","H. Par","H. Rod","Efic.", "ML Plan (m)", "ML Real (m)", "HA Plan (ha)", "HA Real (ha)"];
      const thead = `<thead><tr>${headers.map(h=>`<th class="px-3 py-2 border-b bg-gray-50 text-left text-sm font-semibold">${h}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${linhas.map(l=>`
        <tr class="hover:bg-gray-50">
          <td class="px-3 py-2 text-sm">${l.numeroCroqui}</td>
          <td class="px-3 py-2 text-sm">${l.projeto}</td>
          <td class="px-3 py-2 text-sm">${l.bloco}</td>
          <td class="px-3 py-2 text-sm">${l.bombeamento}</td>
          <td class="px-3 py-2 text-sm">${l.eletrobomba}</td>
          <td class="px-3 py-2 text-sm">${l.carretel}</td>
          <td class="px-3 py-2 text-sm">${l.horasPlanejadas}</td>
          <td class="px-3 py-2 text-sm text-amber-800">${l.horasParadas}</td>
          <td class="px-3 py-2 text-sm text-emerald-800">${l.horasRodadas}</td>
          <td class="px-3 py-2 text-sm font-semibold">${l.eficiencia}</td>
          <td class="px-3 py-2 text-sm">${l.metrosLinearesPlano}</td>
          <td class="px-3 py-2 text-sm font-semibold text-teal-800">${l.metrosLinearesReal}</td>
          <td class="px-3 py-2 text-sm font-semibold text-green-800">${l.hectaresPlano}</td>
          <td class="px-3 py-2 text-sm font-semibold text-green-800">${l.hectaresReal}</td>
        </tr>
      `).join("")}</tbody>`;
      table.innerHTML = `<table class="min-w-full">${thead}${tbody}</table>`;
      tabelaRel.innerHTML = "";
      tabelaRel.appendChild(table);
    }
    
    // ===== NOVO C√ìDIGO PARA RELAT√ìRIO INDIVIDUAL =====
    async function popularFiltroAreaIndividual(areas) {
        const select = $("#filtroAreaIndividual");
        select.innerHTML = `<option value="">-- Selecione uma √Årea --</option>`;
        const areasAtivas = areas.filter(a => a.finalizada !== true);
        areasAtivas.sort((a, b) => (a.bloco || '').localeCompare(b.bloco || ''));
        areasAtivas.forEach(area => {
            const option = document.createElement('option');
            option.value = area.id;
            option.textContent = `${area.bloco} (${area.projeto})`;
            select.appendChild(option);
        });
    }

    $("#btnGerarRelatorioIndividual").addEventListener("click", gerarRelatorioIndividualUI);

    async function gerarRelatorioIndividualUI() {
        const areaId = $("#filtroAreaIndividual").value;
        const ymd = $("#filtroDataRel").value || todayYMD();
        const sumarioInd = $("#sumarioRelIndividual");
        const tabelaInd = $("#tabelaRelIndividual");

        if (!areaId) {
            showMessage("Selecione uma √°rea para gerar o relat√≥rio individual.", "error");
            tabelaInd.innerHTML = '';
            return;
        }

        tabelaInd.innerHTML = `<div class="text-sm text-gray-600">Calculando...</div>`;

        const areaDoc = await getDoc(doc(db, COLLECTION, areaId));
        if (!areaDoc.exists()) {
            showMessage("√Årea n√£o encontrada.", "error");
            tabelaInd.innerHTML = '';
            return;
        }
        const area = areaDoc.data();
        
        const ref = collection(doc(db, COLLECTION, areaId), "paradas");
        const start = new Date(ymd + "T00:00:00.000Z");
        const end = new Date(ymd + "T23:59:59.999Z");
        const qy = query(ref, where("inicioParada", ">=", start.toISOString()), where("inicioParada", "<=", end.toISOString()), orderBy("inicioParada", "asc"));
        const snap = await getDocs(qy);

        let horasParadas = 0;
        let horasHorimetro = 0;
        const paradasTabela = [];

        snap.forEach(s => {
            const p = s.data();
            if (p.houveParada && p.duracaoHoras) {
                horasParadas += Number(p.duracaoHoras) || 0;
            }
             if (p.horimetroFinal && p.horimetroInicial) {
                horasHorimetro += (Number(String(p.horimetroFinal).replace(',','.')) - Number(String(p.horimetroInicial).replace(',','.')));
            }
            if(p.houveParada){
                paradasTabela.push({
                    houveParada: "Sim",
                    tipoEquipamento: p.codParada,
                    problema: (Array.isArray(p.descricaoProblema) ? p.descricaoProblema.join(', ') : '') + (p.descricaoProblemaOutro ? ` (Outro: ${p.descricaoProblemaOutro})` : ''),
                    inicio: formatDateTime(p.inicioParada),
                    fim: formatDateTime(p.fimParada),
                    duracao: (Number(p.duracaoHoras) || 0).toFixed(2),
                    horimetroInicial: p.horimetroInicial || "-",
                    horimetroFinal: p.horimetroFinal || "-",
                    descricaoCompleta: p.descricaoParadaCodigo || ""
                });
            } else {
                 paradasTabela.push({
                    houveParada: "N√£o",
                    tipoEquipamento: "-",
                    problema: "-",
                    inicio: "-",
                    fim: "-",
                    duracao: "-",
                    horimetroInicial: "-",
                    horimetroFinal: "-",
                    descricaoCompleta: "N√£o houve parada"
                });
            }
        });

        if (snap.empty) {
            paradasTabela.push({
                houveParada: "N√£o",
                tipoEquipamento: "-",
                problema: "-",
                inicio: "-",
                fim: "-",
                duracao: "-",
                horimetroInicial: "-",
                horimetroFinal: "-",
                descricaoCompleta: "N√£o houve parada"
            });
        }
        
        const planejadas = Number(area.horasPlanejadas || 0);
        const rodadas = Math.max(0, planejadas - horasParadas);
        const efic = planejadas > 0 ? (rodadas / planejadas) * 100 : 0;

        const velocidade = Number(area.velocidadeCarretel || 0);
        const metrosPlano = Number(area.metrosLineares || 0);
        const metrosReal = rodadas * velocidade;
        const metrosRealHorimetro = horasHorimetro * velocidade;
        const hectaresPlano = metrosPlano * fatorCarreador;
        const hectaresReal = metrosReal * fatorCarreador;

        // Atualiza o sum√°rio individual
        $("#sumPlanejadasInd").textContent = planejadas.toFixed(2);
        $("#sumParadasInd").textContent = horasParadas.toFixed(2);
        $("#sumRodadasInd").textContent = rodadas.toFixed(2);
        $("#sumEficienciaInd").textContent = `${efic.toFixed(1)}%`;
        $("#sumMetrosPlanoInd").textContent = metrosPlano.toFixed(2);
        $("#sumMetrosRealInd").textContent = metrosReal.toFixed(2);
        $("#sumHectaresPlanoInd").textContent = hectaresPlano.toFixed(2);
        $("#sumHectaresRealInd").textContent = hectaresReal.toFixed(2);
        $("#sumMetrosHorimetroInd").textContent = metrosRealHorimetro.toFixed(2);


        // Gera a tabela de paradas
        if (!paradasTabela.length) {
            tabelaInd.innerHTML = `<div class="text-sm text-gray-600">Nenhum registro de parada para o dia.</div>`;
            return;
        }
        const table = document.createElement("div");
        table.className = "overflow-auto";
        const headers = ["Houve?", "Tipo Equip.", "Problema", "In√≠cio", "Fim", "Dura√ß√£o (h)", "Hor√≠metro Inicial", "Hor√≠metro Final", "Descri√ß√£o Completa"];
        const thead = `<thead><tr>${headers.map(h => `<th class="px-3 py-2 border-b bg-gray-50 text-left text-sm font-semibold">${h}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${paradasTabela.map(p => `
            <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm">${p.houveParada}</td>
                <td class="px-3 py-2 text-sm">${p.tipoEquipamento}</td>
                <td class="px-3 py-2 text-sm">${p.problema}</td>
                <td class="px-3 py-2 text-sm">${p.inicio}</td>
                <td class="px-3 py-2 text-sm">${p.fim}</td>
                <td class="px-3 py-2 text-sm">${p.duracao}</td>
                <td class="px-3 py-2 text-sm">${p.horimetroInicial}</td>
                <td class="px-3 py-2 text-sm">${p.horimetroFinal}</td>
                <td class="px-3 py-2 text-sm">${p.descricaoCompleta}</td>
            </tr>
        `).join("")}</tbody>`;
        table.innerHTML = `<table class="min-w-full">${thead}${tbody}</table>`;
        tabelaInd.innerHTML = "";
        tabelaInd.appendChild(table);
    }
    
      // Defina a senha correta aqui
      const SENHA_SECRETA = 'usco123';
      let isAdmin = false;

      function verificarSenha() {
          if (isAdmin) {
              isAdmin = false;
              $("#btnDesbloquear").textContent = "Admin";
              $("#btnDesbloquear").classList.replace('bg-red-600', 'bg-blue-600');
              showMessage("Acesso de administrador encerrado.", "sync");
              // Atualizar a UI para remover bot√µes de admin
              if (!sections.operador.classList.contains("hidden")) {
                  listarAreasOperador();
              }
              return;
          }
      
          const senhaDigitada = prompt("Digite a senha para desbloquear as abas:");

          if (senhaDigitada === SENHA_SECRETA) {
            isAdmin = true;
            liberarAbas();
            $("#btnDesbloquear").textContent = "Logout Admin";
            $("#btnDesbloquear").classList.replace('bg-blue-600', 'bg-red-600');
            showMessage("Acesso liberado! As abas est√£o desbloqueadas.", "success");
            // Atualizar a UI para mostrar bot√µes de admin
            if (!sections.operador.classList.contains("hidden")) {
                listarAreasOperador();
            }
           } else if (senhaDigitada) { // Evita mensagem de erro se o usu√°rio cancelar o prompt
            showMessage("Senha incorreta. Tente novamente.", "error");
           }
      }
      function liberarAbas() {
          $$('.aba-bloqueada').forEach(aba => {
            aba.classList.remove('aba-bloqueada');
          });
          // For√ßa a atualiza√ß√£o do menu mobile para refletir o estado desbloqueado
          const activeTab = $('.tab-btn.active')?.dataset.tab || 'operador';
          atualizarMenuMobile(activeTab);
    }

    // ===== Inicializa√ß√£o =====
    (function popularCodigosParada() {
        const select = $("#descricaoParadaCodigoSelect");
        select.innerHTML = `<option value="">Selecione um c√≥digo</option>`;
        codigosParada.forEach(codigo => {
            const option = document.createElement('option');
            option.value = codigo;
            option.textContent = codigo;
            select.appendChild(option);
        });
    })();

    (function popularProblemas() {
        const container = $("#listaProblemas");
        problemasOpcoes.forEach(problema => {
            const label = document.createElement('label');
            label.className = 'flex items-center p-1 hover:bg-gray-100 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" name="problema" value="${problema}" class="form-checkbox h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-700">${problema}</span>
            `;
            container.appendChild(label);
        });
    })();

    listarAreasCadastro(); 
   
    document.addEventListener('DOMContentLoaded', () => {
      switchTab('operador');
      $('#btnDesbloquear').addEventListener('click', verificarSenha);
    });
  </script>
</body>
</html>